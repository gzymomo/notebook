- [HBASE 与关系数据库同步工具的设计和实现 - kaiti - 代码 - 数据库学习记录 - WRITE-BUG (writebug.com)](https://www.writebug.com/git/R-Cd/kaiti)

# HBASE 与关系数据库同步工具的设计和实现

## 摘 要

因特网的发展已经彻底改变了人们的生活，每时每刻都有大量数据被传送到互联网上，越来越多的数据存取功能开始水平扩展，这样就可以删除和增加存储服务，从而适应多变的业务需求。在做数据存储使用的数据库中，传统的关系数据库虽然在 SQL 查询方面表现良好，但是他们更侧重在一台服务器上，海量数据的存储成为瓶颈，单台服务器无法加载海量数据。另一种存储技术 HBASE 不同于传统的关系数据库，它是基于列存储的非关系数据库，在海量数据的存储和查询方面有很大优势。但是 HBASE 不支持 SQL 查询，而且对于繁复的业务流程难以满足需求。而传统的关系数据库恰好能和 HBASE 互补，如果能使用工具将二者随意转换，那么刚好在弥补彼此的缺点之后，在相应的需要的场景使用不同的数据模式，便能在大数据时代得心应手。

本次论文研究 HBASE 与关系数据库同步工具的设计与实现，旨在提供一个方便快捷的工具，从而使企业在使用的时候可以避免传统关系数据库和 HBASE 的不足点，充分利用二者的优点，适应大数据时代背景和多变的业务需求，从而更好的提供互联网服务。在 Java 环境下，开发一个从关系数据库到 HBASE 的实时增量同步的工具，支持 MS-sqlserver、Oracle、MySQL 三种关系数据库类型。使数据维护人员在进行数据库维护和大数据运算的时候可以本别选用关系数据库和 HBASE，充分发挥两种数据库模式的优点并避开其弊端。而在市面上已经有了 HBASE 和 RDBS 的导出工具，例如 sqoop 等，所以此处我们只做 RDBS 到 HBASES 的同步工具。

关键词 关系数据库 HBASE 同步

Design and Implementation of Data Synchronization Tool Between HBASE And Relational Database ABSTRACT

The development of the Internet has revolutionized the way people live, every moment, a lot of data is transferred to the Internet. With the increasing scale of data, more data access function begins to expand horizontally, so we can delete and add storage services to adapt to changing business needs. And although the performance of traditional relational database is good at SQL queries, but they are more focused on a single server, mass data storage becomes it’s bottleneck, a single server can not load massive amounts of data. The HBASE is unlike traditional relational database, it’s data is stored in a column based on non-relational databases, there is a great advantage in terms of storage and query huge amounts of data. But HBASE does not support SQL queries, but also none complex business processes can meet demand. And if we can just to traditional relational database and HBASE complementary, then just adapt to each other to make up for the shortcomings in the scene corresponding need to use different data patterns, can be very convenient in the era of big data.

This paper is about Design and Implementation HBASE and relational database synchronization tool, designed to provide a convenient and efficient service, so that enterprises can be avoided when using traditional relational databases and inadequate point HBASE, we can make full use of the advantages of both adaptation big data era background and changing business needs, so as to better provide Internet services. We are going to do in java environment, create a database from relationship to real-time synchronization tools to synchronization to HBASE, supporting MS-sqlserver, oracle, Mysql,three type relationships. So when doing database maintenance of large data when you can not only choose this relational databases and HBASE, and also give full play to the advantages of both the database schema and avoid its drawbacks. Because there already has HBASE to RDBS export tools, such as sqoop etc. So here we only do RDBS to HBASES synchronization tool. KEY WORDS Relational database HBASE Synchronize

# 一、绪论

## 1.1 论文背景

在当今互联网时代，数据的存储和分析是重中之重。在平时进行业务流程的时候，我们都会选择关系数据库，并且在处理复杂业务的时候，关系数据库因为其支持 SQL 查询和复杂度高易于处理复杂业务的特性更加适合。但是当数据量增加到一定程度的时候，而且在在涉及到大数据分析和计算的时候，HBASE 因为其存储量大，海量存储计算性能好而成为一个更好的选择。因此本次课题主要解决在从关系数据库增量同步到 HBASE 的时候，所需要解决的三个问题：关系数据库的变化捕捉策略、关系数据表中数据的依赖解决、利用中间文件进行增量同步条性能和稳定性。

目前主要有两个主流的关系数据库和 HBASE 数据导出和监控工具：sqoop 和 flume。

Sqoop 是一个用来将 Hadoop 和关系型数据库中的数据相互转移的工具，可以将一个关系型数据库（例如： MySQL ,Oracle ,Postgres 等）中的数据导进到 Hadoop 的 HDFS 中，也可以将 HDFS 的数据导进到关系型数据库中。sqoop 具有以下特点：1.支持文本文件；2.支持数据追加；3.支持 table 列选取；4.支持数据选取；5.支持 map 数定制；6.支持压缩；7.支持将关系数据库中的数据导入到 Hive、HBase。但是其对于多平台的支持并不够完善，而且已有的体验者提出它具有以下缺点：易用性欠佳，Connector 数据格式支持有限，安全性不好，对 Connector 的限制过死。虽然在之后的版本中，已经进行了很多改进，但是总体来说，我们可以使用其导出功能，但是具体的之后同步，需要自己来实现。可以借鉴其思想和数据流动和存储、传输的思想。

Mybus 是一个开源的实现 MySQL 数据库到 Redis,以及 HBASE 的全量，以及增量同步的工具。它实现了多平台的兼容，并且能自定义同步策略。但是仅支持 MySQL 一种关系数据库、程序有不稳定 bug、文档不健全导致使用复杂而且容易出错。因此只能参考其实现思想。

因为对于实际的需求，以上工具无法满足，因此设计了本工具，具体为以下几点：

1：支持多种关系数据库（sqlserver、Oracle、MySQL）

2：关系数据库到 HBASE 的增量同步，可自定义同步方式（到具体的列、监控同步的时间段）。

3：更好的适应性和移植性，部署、使用简单，统一文件和日志的查看和管理。

## 1.2 论文结构

本论文共分七章，各章的内容安排如下：

第一章 绪论。简述了本次 Hbase 与关系数据库同步工具的设计与实现的项目背景与意义，并确定了论文的研究目标；

第二章 关键技术研究。对在完成本次论文研究所涉及到相关知识进行了详细的研究，并对关系数据库（MySQL、sqlserver、Oracle），Java 开发语言，分布式文件系统 HDFS（Hadoop Distributed Filesystem，hadoop 的分布式文件系统），分布式数据库 HBase 以及 XML 文件技术进行了详细的说明。

第三章 Hbase 与关系数据库同步工具的需求分析。从 Hbase 与关系数据库同步工具的总体设计，到功能需求，再到对于系统的非功能需求都进行了详细的描述和分析。

第四章 Hbase 与关系数据库同步工具的概要设计。从总体结构出发，对整个同步工具进行了模块和子系统的划分，并接着对每一个子系统的设计进行阐述，重点阐述了每个子系统所负责实现的功能和实现的方法。

第五章 Hbase 与关系数据库同步工具的详细设计与实现。在详细设计与实现中，分模块的介绍了各个模块及其交互的详细设计与实现，并用图片的方式展现了实现的真实效果。

第六章 Hbase 与关系数据库同步工具的软件测试。在介绍系统的测试环境的基础上，对系统进行了全面的功能测试和性能测试，并根据测试结果对系统作出了全面细致的总结和评论。

第七章 结束语。毕业设计期间完成的工作进行总结，并针对不足，列出了进一步需要研究和优化的问题。

# 二、关键技术研究

本章将对 Hbase 与关系数据库同步工具的相关技术进行理论性的研究。本章分别对关系数据库（MySQL、SQL Server、Oracle），Java 开发语言，分布式文件系统 HDFS（Hadoop Distributed Filesystem，hadoop 的分布式文件系统），分布式数据库 HBase 以及 XML 文件技术进行了研究与分析，分析了它们的优缺点，并提出了本次论文的研究将如何应用这些技术。

## 2.1 关系数据库介绍

关系数据库，是建立在关系数据库模型基础上的数据库，借助于集合代数等概念和方法来处理数据库中的数据，同时也是一个被组织成一组拥有正式描述性的表格，该形式的表格作用的实质是装载着数据项的特殊收集体，这些表格中的数据能以许多不同的方式被存取或重新召集而不需要重新组织数据库表格。关系数据库的定义造成元数据的一张表格或造成表格、列、范围和约束的正式描述。每个表格（有时被称为一个关系）包含用列表示的一个或更多的数据种类。每行包含一个唯一的数据实体，这些数据是被列定义的种类。当创造一个关系数据库的时候，你能定义数据列的可能值的范围和可能应用于那个数据值的进一步约束。而 SQL 语言是标准用户和应用程序到关系数据库的接口。其优势是容易扩充，且在最初的数据库创造之后，一个新的数据种类能被添加而不需要修改所有的现有应用软件。目前主流的关系数据库有 Oracle、db2、SQL Server、Sybase、MySQL 等。本课题所支持的数据库为 Oracle、SQL Server、和 MySQL。

### 2.1.1 MySQL

```
MySQL是一种开放源代码的关系型数据库管理系统（RDBMS），MySQL数据库系统使用最常用的数据库管理语言--结构化查询语言（SQL）进行数据库管理。
```

### 2.1.2 MS-Sqlserver

SQL Server 是由 Microsoft 开发和推广的关系数据库管理系统（DBMS）。SQL Server 具有以下特点：

真正的客户机/服务器体系结构。

图形化用户界面，使系统管理和数据库管理更加直观、简单。

丰富的编程接口工具，为用户进行程序设计提供了更大的选择余地。

SQL Server 与 Windows NT 完全集成，利用了 NT 的许多功能，如发送和接受消息，管理登录安全性等。SQL Server 也可以很好地与 Microsoft BackOffice 产品集成。

具有很好的伸缩性，可跨越从运行 Windows 95/98 的膝上型电脑到运行 Windows 2000 的大型多处理器等多种平台使用。

对 Web 技术的支持，使用户能够很容易地将数据库中的数据发布到 Web 页面上。

SQL Server 提供数据仓库功能，这个功能只在 Oracle 和其他更昂贵的 DBMS 中才有。

### 2.1.3 Oracle 数据库

Oracle Database，又名 Oracle RDBMS，或简称 Oracle。是甲骨文公司的一款关系数据库管理系统。它是在数据库领域一直处于领先地位的产品。可以说 Oracle 数据库系统是目前世界上流行的关系数据库管理系统，系统可移植性好、使用方便、功能强，适用于各类大、中、小、微机环境。它是一种高效率、可靠性好的 适应高吞吐量的数据库解决方案。Oracle 数据库具有以下特点：

- 完整的数据管理功能
- 数据的大量性
- 数据的保存的持久性
- 数据的共享性
- 数据的可靠性

## 2.2 Java 语言介绍

Java 是在人类计算机史上影响深远的编程语言，它是一门非常纯粹的面向对象编程语言，不仅吸收了 C++ 语言的各种优点，还摒弃了 C++ 里难以理解的多继承、指针等概念，因此 Java 语言具有功能强大和简单易用两个特征。Java 语言作为静态面向对象编程语言的代表，极好地实现了面向对象理论，允许程序员以优雅的思维方式进行复杂的编程。

Java 具有简单性、面向对象、分布式、健壮性、安全性、平台独立与可移植性、多线程、动态性等特点。Java 可以编写桌面应用程序、Web 应用程序、分布式系统和嵌入式系统应用程序等。因此，在设计本课题中的工具的时候，我们选择了 Java 作为开发语言，保证了工具能跨平台运行并且有很好的稳定性和较高的性能。

线程和进程:

进程是指一个内存中运行的应用程序，每个进程都有自己独立的一块内存空间，一个进程中可以启动多个线程。比如在 Windows 系统中，一个运行的 exe 就是一个进程。线程是指进程中的一个执行流程，一个进程中可以运行多个线程。比如 java.exe 进程中可以运行很多线程。线程总是属于某个进程，进程中的多个线程共享进程的内存。在 Java 中，“线程”指两件不同的事情：

java.lang.Thread 类的一个实例；

线程的执行。

## 2.3 HDFS 概述

Hadoop[11]是 Apache 开发的分布式系统的基础架构。它的核心项目之一 HDFS[12] （Hadoop Distributed Filesystem，hadoop 的分布式文件系统）是具有高可靠性和伸缩性的分布式文件系统。HDFS 具有很好的容错机制，可以部署在廉价硬件组成的的集群上。同时 HDFS 也具备很好地扩展性和较高的吞吐率。

图 2-6 中所示，一个 HDFS 集群是由一个 NameNode 和多个 DataNode 组成的。HDFS 中存储的文件是以数据块的形式存储在多个 DataNode 中，一个文件可能对应一个或多个数据块。而 NameNode 的职责则是负责管理文件系统的命名空间和控制文件的访问。在 HDFS 文件系统中，有两个重要的映射关系，一个是文件名到数据块的映射，另一个是数据块到存储该数据块的 DataNode 之间映射。总的来所 NameNode 负责文件系统的管理和访问，而 DataNode 则负责实际的数据储存。

## 2.4 HBase 概述

HBase[13]数据库是 Goole BigTable 在 Hadoop 框架上的一个具体实现。它是一种键值储存、面向列族的数据库，它是基于行键、列键、时间戳简历索引。但从根本上来说它是一个可以随机访问的存储和检索数据平台[14]。同样 HBase 作为本本论文基于 Flume 的日志采集系统的另一个重要存储系统，本论文对 HBase 也进行了重点的了解和学习。

### 2.4.1 HBase 的逻辑数据模型

HBase 是一个稀疏的、多维的面向列的分布式数据库。也正是因为 HBase 是一种

面向列存储的数据库，它十分擅长存数非结构化的稀疏数据。简单地来说，HBase 数据被建模为多位映射表，表通过四个键值索引，即 HBase 的数据模式可以表示为：value=Map(Tablename,RowKey,ColumnKey,Timestamp)，其中

TableName 是一个字符串 ,定位一个表。

RowKey 是数据在表中的唯一标识 , 是表中检索记录的主键,行通过 RowKey 进行字典排序。

ColumnKey 是表的列关键字,列名字的格式是 “ : ”,都是字符串构成的,同一个表里的每一行数据都可以有截然不同的列。每个表都会有个列簇集合,且是固定不变的,只有通过该表表结构来改变,但是qualifier 相对于一行是可以改变的。

TimeStamp 对应着每次数据操作所关联的时间,可以由用户赋值,也可由系统自动生成。其中数据回归方式也有两种,一个是保存一段时间内的版本,另一个是保存最近的几个版本。

### 2.4.2 HBase 的物理数据模型

从逻辑视图上看,每个表格是由多个列组成的,但是在物理存储上,是按列存储的 ,就是对其中的一行进行分割 , 每个列族储存在 HDFS 上的一个单独的文件中，而在每个列族的 HDFS 文件中都有一份 Rowkey 和时间戳，这样就更加便于 HBase 数据库的随机访问。与逻辑模型不同的是,逻辑模型中存在空白列,这些列是不存储数据的,当请求这些空白列时 ,会返回 null 值。物理模型中不存在空白列。并且如果用户查询数据时不提供时间戳,那么返回的数据版本就是离现在最近的版本,因为数据是按时间戳排序存储的。

## 2.5 XML 技术概述

可扩展标记语言，标准通用标记语言的子集，是一种用于标记电子文件使其具有结构性的标记语言。在电子计算机中，标记指计算机所能理解的信息符号，通过此种标记，计算机之间可以处理包含各种的信息比如文章等。它可以用来标记数据、定义数据类型，是一种允许用户对自己的标记语言进行定义的源语言。 它非常适合万维网传输，提供统一的方法来描述和交换独立于应用程序或供应商的结构化数据。是 Internet 环境中跨平台的、依赖于内容的技术，也是当今处理分布式结构信息的有效工具。

### 2.5.1 XML 语法

任何的起始标签都必须有一个结束标签。

可以采用另一种简化语法，可以在一个标签中同时表示起始和结束标签。这种语法是在大于符号之前紧跟一个斜线（/），例如 < 百度百科词条/>。XML 解析器会将其翻译成 < 百度百科词条 ></百度百科词条 >。

标签必须按合适的顺序进行嵌套，所以结束标签必须按镜像顺序匹配起始标签，例如这是一串百度百科中的样例字符串。这好比是将起始和结束标签看作是数学中的左右括号：在没有关闭所有的内部括号之前，是不能关闭外面的括号的。

所有的特性都必须有值。

所有的特性都必须在值的周围加上双引号。

### 2.5.2 示例

```
<note>
<to>George</to>
<from>John</from>
<heading>Reminder</heading>
<body>Don't forget the meeting!</body>
</note>
```

# 三、Hbase 与关系数据库同步工具的需求分析

为了实现从关系数据库到 HBASE 数据同步的功能，本文将在研究、借鉴其他人研究的基础上，设计并实现出一套跟适用于我们自己实际需求的同步工具，以在实现数据同步的同时，从节约实现成本成本、提高性能和实现同步过程过程的可控和提供对同步结果的实时查看等方面出发做出更加细致的设计和实现。本章简单的介绍了系统的设计目标、系统的功能需求和系统的非功能需求。

## 3.1 Hbase 与关系数据库同步工具的设计目标

在当今互联网时代，数据的存储和分析是重中之重。在平时进行业务流程的时候，我们都会选择关系数据库，并且在处理复杂业务的时候，关系数据库因为其支持 SQL 查询和复杂度高易于处理复杂业务的特性更加适合。但是当数据量增加到一定程度的时候，而且在在涉及到大数据分析和计算的时候，HBASE 因为其存储量大，海量存储计算性能好而成为一个更好的选择。

本文旨在提供一个从关系数据库到 HBASE 的增量同步解决方案，从而能使用户在使用数据的时候，能只需要专注于自己需要的数据来进行存储和计算，从而大大减少工作量，提高开发效率。并在完成所要求的功能的前提下，提高工具的性能和效率，并且让其适应多个系统，能在不同场景下能稳定高效的运行。

## 3.2 Hbase 与关系数据库同步工具的功能需求

为了实现本次需求的同步功能，更有利于对数据同步进行控制和管理，在本次 Hbase 与关系数据库同步工具设计和实现中提出了如下三个核心的功能需求：同步过程中的数据库管理、同步过程中的文件管理、同步过程中的变化捕捉。接下来，本节将会对这三个需求进行了更加深入的分析。

下图是系统的总体用例图：

[![img](https://www.writebug.com/myres/static/uploads/2022/5/29/da0cd6a2770792a8a1d7f279a780a73d.writebug)](https://www.writebug.com/office/imagePreview?imgurl=https://www.writebug.com/myres/static/uploads/2022/5/29/da0cd6a2770792a8a1d7f279a780a73d.writebug)

图 3-1 系统整体用例示意图

### 3.2.1 同步过程中的数据库管理的功能需求

数据库同步中的数据库管理是为了之后的同步做准备，因此为了能顺利的完成同步，所以从性能需求和节约本出发，在数据库管理的功能需求中需要系统做到如下一些基本功能：

关系数据库的连接和监控、读取：

在对关系数据库的管理当中，我们需要做到读取配置文件中的数据库信息之后，利用配置参数对关系数据库进行连接。然后配置参数中包含了一些其他的对关系数据库的管理、监控的参数，我们只需要按照参数进行相应的配置即可

在最终的成功的关系数据库管理场景中：我们能做到对关系数据库的连接、关系数据库的变化捕捉、关系数据库的变化存储和同步、定时的进行同步。。

HBASE 数据库的连接和写入：

在数据库配置文件当中包含了 HBASE 的地址等配置信息，我们只需要按照参数对其进行连接和读取。并且在对关系数据库的监控和读取过程完成之后，我们会得到存储了很多需要存储的数据的中间文件，本次需求的功能就需要将中间文件中的数据读取出来并最终分类存储到 HBase 不同数据表中。

### 3.2.2 同步过程中文件管理的功能需求

在所有同步系统中，不仅仅是要完成功能，还需要对过程进行记录和保存，以便于在之后进行管理和查找。因此，各种用于记录的文件是必不可少的，本工具也提供了各种文件管理。主要包含以下几项：配置文件、关系数据库日志表 log 记录、中间文件、存入 HBASE 的 log 记录。

接下来是对应的说明：

配置文件

每次操作的输入方式为配置文件输入。可以在配置文件中自定义要输入的参数（在已参数类型的子集中），然后通过读取参数直接开始处理，便于管理也不易于出错。配置文件采用 XML 文件，每个相应参数均在 XML 文件的元中定义。附配置文件示例如下：

```
<?xml version="1.0" encoding="GB2312"?>
                             <config>
                             <RDB>//关系数据库表
                             <type>mysql</type>//数据库类型
                             <address>127.0.0.1:3306</address>//地址
                             <username>root</username>//用户名
                             <password>111111</password>//密码
                             <databases>//一个数据库地址包含多个database
                             <database>//一个database包含多个table,每个表都要设置同步到哪里
                             <name>WebDevelopment</name>
                             <tables>
                             <table>
                             <tablename>Merchant</tablename>//要同步的表
                             <sync>Merchant</sync>//同步到HBASE的哪个表中
                             <timespace>2016/3/11	12:31:30	--	2016/3/21	12:31:20</timespace>//同步的时间段
                             </table>
                             <table>
                             <tablename>Customer</tablename>//要同步的表
                             <sync>Customer</sync>//同步到HBASE的哪个表中
                             <timespace>2016/3/11 12:31:30 -- 2016/3/21 12:31:20</timespace>//同步的时间段
                             </table>
                             </tables>
                             </database>
                             </databases>
                             </RDB>
                             <HBASE>
                             <address>127.0.0.1:6666</address>
                             <username>admin</username>
                             <password>111111</password>
                             </HBASE>
                             </config>
```

关系数据库日志表 log 记录：

该日志记录了从日志表到中间文件转换过程的所有记录，采用 txt 格式，便于用户查看。包含如下字段：

表 3-1 关系数据库日志表 log 记录文件字段表

| 字段名         | 含义                |
| -------------- | ------------------- |
| time           | 该操作的时间        |
| tabile_changed | 发生变化的表的名称  |
| action         | 变化的类型          |
| toHbase        | 同步到的 HBASE 表名 |
| success/not    | 成功与否            |
| count          | 该次操作的条数      |
| tps            | 每秒处理的次数      |

中间文件

中间文件是在读取日志表之后，根据日志表中的信息再次读取变化的数据库表，得到数据进行表模式转换，得到能存入 HBASE 中的数据，存入中间文件，然后存表模块读取中间文件，将数据同步入 HBASE。中间文件采用 txt 格式，方便用户查看，同时中间文件设置了每当达到一定大小就备份并销毁的功能，防止过大导致读取速度变慢。以下是中间文件的字段设计：

表 3-2 同步中间文件字段表

| 字段名         | 含义                             |
| -------------- | -------------------------------- |
| id             | 记录每一条的标识                 |
| time           | 每条数据转换为中间文件时的时间   |
| tabile_changed | 发生变化的表的名称               |
| action         | 变化的类型                       |
| to_table       | 同步到的 HBASE 表名              |
| 其他所有数据   | 该行的所有数据的列名和具体的值。 |

存入 HBASE 的 log 记录

表 3-3 存入 HBASE 的 log 文件字段表

| 字段名      | 含义                |
| ----------- | ------------------- |
| time        | 该操作的时间        |
| tabile      | 同步到的 HBASE 表名 |
| action      | 变化的类型          |
| success/not | 成功与否            |
| count       | 该次操作的条数      |
| tps         | 每秒处理的次数      |

### 3.2.3 同步过程中的变化捕捉的功能需求

对关系数据库进行变化捕捉是本次需求分析的核心需求，也是本次工具设计的核心。我们需要在目标关系数据库上设置触发器然后进行每次变化的捕捉然后存入新的日志表进行下一步的存取。接下来本文将以用例说明的方式更加细致的描绘功能需求，接下来是对应的用例说明：

表 3-4 数据库变化捕捉用例说明表

| 用例编号                                                     | 用例编号                                                     | UC001                                                        |
| ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 用例名称                                                     | 用例名称                                                     | 连接关系数据库                                               |
| 参与者                                                       | 参与者                                                       | 用户                                                         |
| 成功场景                                                     | 成功场景                                                     | 成功场景                                                     |
| 1                                                            | 用户用户按照要求配置正确的配置文件                           | 用户用户按照要求配置正确的配置文件                           |
| 2                                                            | 用户运行该工具                                               | 用户运行该工具                                               |
| 3                                                            | 工具自动进行变化监控                                         | 工具自动进行变化监控                                         |
| 4                                                            | 工具在每次数据库变化的时候将变化存入日志表                   | 工具在每次数据库变化的时候将变化存入日志表                   |
| 分支场景 < 针对成功场景某个步骤的分支描述，如 1a 是针对上述步骤 1 的 > | 分支场景 < 针对成功场景某个步骤的分支描述，如 1a 是针对上述步骤 1 的 > | 分支场景 < 针对成功场景某个步骤的分支描述，如 1a 是针对上述步骤 1 的 > |
| 4a                                                           | 连接好 HBASE                                                 | 连接好 HBASE                                                 |
| 4b                                                           | 工具根据关系数据库的结构生成相应的文件夹                     | 工具根据关系数据库的结构生成相应的文件夹                     |
| 4c                                                           | 工具在连接到具体的表之后，生成文件夹下面的具体文件           | 工具在连接到具体的表之后，生成文件夹下面的具体文件           |

表 3-5 变化数据存入日志表用例说明表

| 用例编号                                                     | 用例编号                                                     | UC002                                                        |
| ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 用例名称                                                     | 用例名称                                                     | 数据库变化存入日志表                                         |
| 参与者                                                       | 参与者                                                       | 用户                                                         |
| 成功场景                                                     | 成功场景                                                     | 成功场景                                                     |
| 1                                                            | 工具完成数据库的连接                                         | 工具完成数据库的连接                                         |
| 2                                                            | 完成数据表的监控                                             | 完成数据表的监控                                             |
| 3                                                            | 被监控的数据库发生变化                                       | 被监控的数据库发生变化                                       |
| 4                                                            | 变化的相应信息被存入日志表                                   | 变化的相应信息被存入日志表                                   |
| 分支场景 < 针对成功场景某个步骤的分支描述，如 1a 是针对上述步骤 1 的 > | 分支场景 < 针对成功场景某个步骤的分支描述，如 1a 是针对上述步骤 1 的 > | 分支场景 < 针对成功场景某个步骤的分支描述，如 1a 是针对上述步骤 1 的 > |
| 4a                                                           | 日志表会在随后被其他模块读取                                 | 日志表会在随后被其他模块读取                                 |

表 3-6 中间文件存入用例说明表

| 用例编号                                                     | 用例编号                                                     | UC003                                                        |
| ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 用例名称                                                     | 用例名称                                                     | 中间文件存入                                                 |
| 参与者                                                       | 参与者                                                       | 用户                                                         |
| 成功场景                                                     | 成功场景                                                     | 成功场景                                                     |
| 1                                                            | 工具完成数据库的连接                                         | 工具完成数据库的连接                                         |
| 2                                                            | 完成数据表的监控                                             | 完成数据表的监控                                             |
| 3                                                            | 被监控的数据库发生变化                                       | 被监控的数据库发生变化                                       |
| 4                                                            | 变化的相应信息被存入日志表                                   | 变化的相应信息被存入日志表                                   |
| 5                                                            | 读取日志表并根据日志表读取数据库                             | 读取日志表并根据日志表读取数据库                             |
| 6                                                            | 将读取的数据存入中间文件                                     | 将读取的数据存入中间文件                                     |
| 分支场景 < 针对成功场景某个步骤的分支描述，如 1a 是针对上述步骤 1 的 > | 分支场景 < 针对成功场景某个步骤的分支描述，如 1a 是针对上述步骤 1 的 > | 分支场景 < 针对成功场景某个步骤的分支描述，如 1a 是针对上述步骤 1 的 > |
| 4a                                                           | 中间文件会被存表模块读取并存入 HBASE                         | 中间文件会被存表模块读取并存入 HBASE                         |

## 3.3 Hbase 与关系数据库同步工具非功能性需求

高吞吐率：在本次的同步工具中，吞吐率是指单位时间能够采集的日志条数。通过调研发现单台服务器每秒产生的日志条数大概在 1~2 万条，所以本论文设计的日志采集也应该具备 1~2 万这样较高的吞吐率。

- 高可靠性：高可靠性是指数据同步要具有高度的准确性，即不能出现数据在同步过程中丢失的情况。所以系统在没有机械故障等情况下，应该要确定采集准确性的 100%。
- 易部署性：易部署性是指设计出来的同步工具能够被轻松地部署到服务器上，不需消耗大量的人力手动操作的成本。
- 良好的交互性：在实现日志采集过程的可视化和已采集数据的易操作性时，既要对用户提供简便快速高效的交互操作，也要给用户反馈美观易读的交互信息。

# 四、Hbase 与关系数据库同步工具的概要设计

本章将对 Hbase 与关系数据库同步工具的总体设计进行详细阐述。首先对系统的架构设计和模块划分进行了描述，接着有对每一个模块的设计和所要负责实现的需求进行了描述。

## 4.1 系统总体框架

在上一章对于需求细致分析的基础，本章为了更加全面更加高效更加合理的实现上述需求，对于本系统的设计实现提出了如图 4-1 所示的系统功能结构图：

[![img](https://www.writebug.com/myres/static/uploads/2022/5/29/b28e974c87a7bd135c6cbda7b4ecd0e1.writebug)](https://www.writebug.com/office/imagePreview?imgurl=https://www.writebug.com/myres/static/uploads/2022/5/29/b28e974c87a7bd135c6cbda7b4ecd0e1.writebug)

从上图可以看到，整个系统分为三个大的功能模块：数据库管理、数据同步、文件管理。具体来说这三个功能的实现我们会在接下来进行详细描述。

接下来是该系统的系统模块划分：

[![img](https://www.writebug.com/myres/static/uploads/2022/5/29/ff3fc7126283a7891973f28293e88100.writebug)](https://www.writebug.com/office/imagePreview?imgurl=https://www.writebug.com/myres/static/uploads/2022/5/29/ff3fc7126283a7891973f28293e88100.writebug)

读表模块设计：

读表模块是在工具初始阶段，进行表连接和表监控的重要模块，具体来说主要是要实现如下几项功能：

- 配置文件的读取和解析；
- 配置文件参数传递；
- 利用参数连接关系数据库和 HBASE；
- 对关系数据库进行变化监控。
- 读取监控变化信息，存入日志表文件中。

表连接模块：

表连接模块主要对数据库进行管理，具体来说主要是要实现如下几项功能：

- 配置文件信息的读取；
- 配置参数的传递；
- 数据库的连接。

变化捕捉模块：

主要完成变化捕捉的功能：

- 连接数据库。
- 对数据库进行触发器插入。
- 在目标数据库中监理日志表，存储变化
- 导出数据读取模块主要完成变化存入日志表文件的功能：
- 连接数据库。
- 读取记录的变化的字段。
- 将变化的字段存入日志表文件

## 4.2 表处理模块的概要设计

通过之前的表连接和变化捕捉设计，已经为我们之后的工作打好了基础，我们只需要将读表模块生成的文件进行读取和处理，即可完成后续工作。本模块主要职责如下所示：

- 读取日志表文件中的文件内容。
- 根据日志表文件读取数据库，拿到需要的字段和数据。
- 对数据进行处理，解决依赖，然后存入中间文件。
- 接下来我们会进行详细的阐述，为随后的详细设计与实现打下坚实的基础。

### 4.2.1 依赖解决的概要设计

- 结合需求的分析和之前文件的读取，现在需要解决依赖然后存入 HBASE。因此本模块主要就完成以来解决的功能；
- 读取日志表文件中的字段和数据。
- 根据日志表文件的数据在数据库中读取相应的数据；
- 将读取出来的数据进行表模式转换，然后存入中间文件。

### 4.2.2 数据传输模块的概要设计

在以来解决模块完成表模式处理之后，我们之后就需要将处理后的数据存入中间文件然后传输给存表模块。然后对之前处理的文件和数据等进行备份，然后将每次处理、每次存储记录日志，方便之后管理。

具体如下：

- 将处理数据按照行存入中间文件。
- 对过大的中间文件进行备份。
- 处理过程存入日志。
- 备份所有相关文件.

## 4.3 存表模块的概要设计

### 4.3.1 HBASE 存储模块的架构设计

HBASE 存表模块只完成一件事情：将中间文件中的内容存入 HBASE.。并将结果和过程存入日志，以下是详细描述：

- 将中间文件中的数据读取出来并解析。
- 解析完成之后，根据配置文件连接 HBASE。
- 连接完成，根据中间文件中的配置，将数据存入 HBASE。
- 将存储过程写进日志，备份相应文件

## 4.4 日志表、中间文件、日志结构设计

在数据库方面，本论文采用分布式数据库 HBase 负责存储数据。虽然 HBase 是非关系性数据库，但是良好的数据表设计对于功能有着极大的影响，所以结合需求设计了如下的数据库表：

触发器设计

表 4-1 触发器设计表

| 触发器类型 | 名称和功能                        |
| ---------- | --------------------------------- |
| Insert     | Insert_表名，记录所有 insert 变化 |
| Delete     | delete_表名，记录所有 delete 变化 |
| Update     | delete_表名，记录所有 delete 变化 |

日志表的设计

表 4-2 日志表

| 元素 | 说明                                 |
| ---- | ------------------------------------ |
| 表名 | Change_table_from_trigger            |
| 作用 | 存储变化信息                         |
| 字段 | Table action time primary_key key 值 |

中间文件字段表

表 4-3 中间文件字段表

| 字段名         | 含义                             |
| -------------- | -------------------------------- |
| id             | 记录每一条的标识                 |
| time           | 每条数据转换为中间文件时的时间   |
| tabile_changed | 发生变化的表的名称               |
| action         | 变化的类型                       |
| to_table       | 同步到的 HBASE 表名              |
| 其他所有数据   | 该行的所有数据的列名和具体的值。 |

日志表向中间文件 log

表 4-4 日志表向中间文件 log 表

| 字段名         | 含义                |
| -------------- | ------------------- |
| time           | 该操作的时间        |
| tabile_changed | 发生变化的表的名称  |
| action         | 变化的类型          |
| toHbase        | 同步到的 HBASE 表名 |
| success/not    | 成功与否            |
| count          | 该次操作的条数      |
| tps            | 每秒处理的次数      |

中间文件向 HBASElog 表

表 4-5 中间文件向 HBASElog 表

| 字段名      | 含义                |
| ----------- | ------------------- |
| time        | 该操作的时间        |
| tabile      | 同步到的 HBASE 表名 |
| action      | 变化的类型          |
| success/not | 成功与否            |
| count       | 该次操作的条数      |
| tps         | 每秒处理的次数      |

## 4.5 系统架构

该工具在设计实现过程中遵循如下设计思想:

- Intemet 环境中,实现可配置的手动导出与自动同步机制,保证可靠性前提下的成本有效实现。
- 充分保证用户应用的自治性,在不影响原用户应用系统的前提下,于后台以中间件方式完成数据同步。
- 基于 Java 虚拟机,可跨操作系统平台使用,具有精简同步功能集且便于扩展的异构数据库同步中间件平台软件。

下图是该工具的环境位置：

[![img](https://www.writebug.com/myres/static/uploads/2022/5/29/410f1c6d666191e7cfae7f6665aaf2c6.writebug)](https://www.writebug.com/office/imagePreview?imgurl=https://www.writebug.com/myres/static/uploads/2022/5/29/410f1c6d666191e7cfae7f6665aaf2c6.writebug)

图 4-3 系统外部环境示意图

下图是一次完整的数据同步过程时序图：

[![img](https://www.writebug.com/myres/static/uploads/2022/5/29/33b381935f3e0246664c94539bd31f74.writebug)](https://www.writebug.com/office/imagePreview?imgurl=https://www.writebug.com/myres/static/uploads/2022/5/29/33b381935f3e0246664c94539bd31f74.writebug)

图 4-4 一次完整流程图

## 4.6 小结

在读取配置文件之后，根据配置文件信息链接数据库，可以读取数据库的信息之后，在事先设定好的特定的文件夹（RDBS）下新建一个用该数据库地址命名的文件夹，下面会有 log、backup（同步数据备份）、middlefile（同步数据中间文件）三个文件夹，存储相应的文件。

同步过程中，在文件夹 RDBS 同级目录下面会有 HBASE 文件夹，功能和内容同 RDBS 文件夹。

以上部分是为了在每次建立新的数据库连接和进行同步时候便于管理和备份、查看日志等。方便之后的断点续传等功能。

通过 JDBC/HDBC 进行关系数据库的触发器注入和操作，生成中间信息存入中间信息 XML 文件、日志等，放入 RDBS 文件夹，然后用表处理模块进行依赖解除之后替换成新的可以存入 hbase 的中间文件存入 HBASE 文件夹，然后存表模块读取 HBASE 文件夹下面的中间文件，然后存表，生成日志等存入相应文件夹。

中间文件统一用 txt 格式，便于用户查看；中间文件要设置有大小上限

日志文件用 txt 格式，记录相应的内容即可。

整个工具的设计和开发过程遵循软件工程思想，并综合各种方案，选取在节省成本的同时，保证最好性能的方案。在设计过程中，借鉴过其他人的方案，我自己也有加入自己的想法，并在实践中不断改进。因此在此过程中我学习到了很多软件工程和服务设计的知识，加深了自己对软件设计的理解，拓宽了自己的知识面。

# 五、Hbase 与关系数据库同步工具的详细设计与实现

## 5.1 工具中的模块具体实现

模块总体结构图如下：

[![img](https://www.writebug.com/myres/static/uploads/2022/5/29/901f0b335e96169df93cf908836a139e.writebug)](https://www.writebug.com/office/imagePreview?imgurl=https://www.writebug.com/myres/static/uploads/2022/5/29/901f0b335e96169df93cf908836a139e.writebug)

以下是三个模块的流程图：

### 5.1.1 读表模块：

[![img](https://www.writebug.com/myres/static/uploads/2022/5/29/cea75e7385492e442b6949d5d7ae55b7.writebug)](https://www.writebug.com/office/imagePreview?imgurl=https://www.writebug.com/myres/static/uploads/2022/5/29/cea75e7385492e442b6949d5d7ae55b7.writebug)

读取配置文件成功之后，根据参数连接数据库并本剧数据库参数生成文件夹和初始化文件，然后对目标数据表插入触发器。在每一步如果发生了错误，都会进行控制台输出并记录日志。成功之后，会进入下一模块并生成日志文件。

## 5.2 表处理模块

[![img](https://www.writebug.com/myres/static/uploads/2022/5/29/38076d47e01969d499053a4febef391d.writebug)](https://www.writebug.com/office/imagePreview?imgurl=https://www.writebug.com/myres/static/uploads/2022/5/29/38076d47e01969d499053a4febef391d.writebug)

模块直接读取目标数据库中的日志表，然后根据日志表中的数据，读取该数据库中相应的表的数据，并存入日志表文件，然后读取日志表文件，对数据进行解耦，处理之后，存入中间文件。在每一步如果发生了错误，都会进行控制台输出并记录日志。成功之后会生成可供存表模块读取的中间文件和日志文件。

## 5.3 存表模块

[![img](https://www.writebug.com/myres/static/uploads/2022/5/29/bf316ffd90a1fb113247f6f933bcba4d.writebug)](https://www.writebug.com/office/imagePreview?imgurl=https://www.writebug.com/myres/static/uploads/2022/5/29/bf316ffd90a1fb113247f6f933bcba4d.writebug)

模块直接读取中间文件，然后读取配置文件中 HBASE 地址等信息，连接 HBASE，然后根据中间文件中的数据，存入 HBASE，然后生成日志文件。在每一步如果发生了错误，都会进行控制台输出并记录日志。成功之后会发现数据已经全部同步到 HBASE 中了，并有日志文件记录同步是否成功。

## 5.4 变化捕捉策略

关系数据库变化捕捉和同步策略之间联系紧密，因此一个准确高效的变化捕捉策略是必不可少的，而在市面上有各种解决方案供我们选择。通过比较，我们选择以下解决方案。

### 5.4.1 方案分析

杨鹏的论文：《异构数据库同步中间件的设计和实现》中提出了一种基于触发器和专用数据表（自定义的日志表）的数据变化捕捉方法：日志表法。通过触发器将同步所需的变更控制信息记录在统一的表中，这张存有变更控制信息的表被称日志表，在同步时，根据日志表提供的同步控制信息，对更改的数据进行同步。

日志表设计：

| 字段         | 数据类型    | 记录内容         | 备注     |
| ------------ | ----------- | ---------------- | -------- |
| key_field    | varchar(32) | 变更数据项主键   |          |
| source_field | varchar(32) | 数据项所在表名称 |          |
| time_field   | varchar(1)  | 变更类型         | U/N/D    |
| type_field   | datatime    | 变更时间         | 系统时钟 |
| ucn_field    | int         | 列更新信息       | 默认为 0 |

触发器设计：

- 在同步表上建立触发器,针对 INSERT、UPDATE 和 DELE 住操作,触发器
- 完成不同工作,将必要的控制信息记录在日志表中。由于不同数据库中触发器语
- 法不尽相同,流程图中使用伪代码,其中 synceslog 为日志表名称;syncTN 为同步
- 表名称;keycN 为同步表主键字段名称;oldR 表示变更前的记录;NewR 表示变
- 更后的记录;ct 为当前时间。

### 5.4.2 新建记录触发器详细设计

在同步表上执行 INSERT 操作时,触发器的工作流程如下图所示。DML 操作新建一条记录时,针对 INSERI,操作的触发器将新建记录的主键值记入日志表的 key_field 字段;将表名称记入 source_field 字段;将变更状态“N”记入 tyPe_field 字段;将操作时间记入 time_field 字段。如果日志表内己经存在该条记录的控制信息(即 key_field 字段内的值等于该记录的主键且 source_field 字段记录的值等于表名称),则使用本次 DML 操作的控制信息更新日志表中的记录。工作流图如下：

[![img](https://www.writebug.com/myres/static/uploads/2022/5/29/9ca471b9116aa8615fc1338b0e4f1990.writebug)](https://www.writebug.com/office/imagePreview?imgurl=https://www.writebug.com/myres/static/uploads/2022/5/29/9ca471b9116aa8615fc1338b0e4f1990.writebug)

流程说明：

- 开始时，如果已经存在触发器，那么查看其内容，进行判断；
- 如果是更行，那就插入更新表；
- 如果是插入表，就插入插入表。

### 5.4.3 更新记录触发器的详细设计

在同步表上执行 uPDATE 操作时,触发器首先判断发生更新的字段是否为主键,若主键发生更新,则先删除日志表中所有与旧主键值对应的日志记录,然后记录下两条新的控制信息,一条标志出旧主键值对应的记录被删除,另一条标志出新主键值对应的记录被插入，工作流图如下：

[![img](https://www.writebug.com/myres/static/uploads/2022/5/29/ae37b927061c91d4c6d7689c6429d93a.writebug)](https://www.writebug.com/office/imagePreview?imgurl=https://www.writebug.com/myres/static/uploads/2022/5/29/ae37b927061c91d4c6d7689c6429d93a.writebug)

### 5.4.4 删除记录触发器的详细设计

在同步表上执行 DELETE 操作时,触发器的工作流程如图 3.4 所示。DML 语句删除表内一条记录时,此前日志表内该记录对应的所有控制信息都已经没有意义,触发器首先删除日志表内该记录的所有旧控制信息,然后新建状态为 D 的对应控制信息。

[![img](https://www.writebug.com/myres/static/uploads/2022/5/29/80a65123c454ae9347dc307a1e8d9a7e.writebug)](https://www.writebug.com/office/imagePreview?imgurl=https://www.writebug.com/myres/static/uploads/2022/5/29/80a65123c454ae9347dc307a1e8d9a7e.writebug)

## 5.5 关系数据库数据依赖解决（表模式转换）

在处理关系数据表数据的时候，由于关系数据库数据存在主键外键等依赖，必须将其进行必要的处理，做到表模式的转换，才能合理妥当的存入 HBASE。

以下是四种表模式转换方式：

### 5.5.1 基本变换

适用场景

以传统关系数据库中表设计模式定义的表变换成 HBase 中的表。

变换方法

Goods 表为表 1，把表 1 的表名作为 HBase 中对应的表名，表 1 也添加到这个表的列族中。之后把表 1 的主键作为对应表的行键。

最后把表 1 中定义的所有属性添加到对应表的列族 1 中。

| Goods 表 | Goods 表  |
| -------- | --------- |
| GoodsId  | GoodsName |
| 1        | 桌子      |
| 2        | 椅子      |

| Goods 表 | Goods 表   | Goods 表       |
| -------- | ---------- | -------------- |
| 行键     | Goods 列族 | Goods 列族     |
| 1        | GoodsId=1  | GoodsName=桌子 |
| 2        | GoodsId=2  | GoodsName=椅子 |

### 5.5.2 内嵌变换

适用场景

查询表 1 中的某一行时就能够得到同这一行所关联的所有表 2 中的数据，这样就可以避免表 1 和表 2 的连接查询。

方法

Goods 表为表 1、Color 表为表 2，表 1 的表名作为 HBase 中对应的表名；把表 1 和表 2 添加到列族中。表 1 的主键作为对应表的行键，随后把表 1 中定义的所有属性添加到对应表的列族 1 中，把表 2 中所有同表 1 这一行有关的所有行属性都放入到列族 2 中。根据情况删除表 2。

| Goods 表 | Goods 表  |
| -------- | --------- |
| GoodsId  | GoodsName |
| 1        | 桌子      |
| 2        | 椅子      |

| Goods 表 | Goods 表  |
| -------- | --------- |
| GoodsId  | GoodsName |
| 1        | 桌子      |
| 2        | 椅子      |

| Color 表 | Color 表  |
| -------- | --------- |
| ColorId  | ColorName |
| 1        | 黑色      |
| 2        | 红色      |

| Goods 表 | Goods 表   | Goods 表       | Goods 表                | Goods 表                |
| -------- | ---------- | -------------- | ----------------------- | ----------------------- |
| 行键     | Goods 列族 | Goods 列族     | Color 列族              | Color 列族              |
| 1        | GoodsId=1  | GoodsName=桌子 | ColorId=1ColorName=黑色 | ColorId=2ColorName=红色 |
| 2        | GoodsId=2  | GoodsName=椅子 | ColorId=1ColorName=黑色 |                         |

### 5.5.3 分割变换

当从表 3 与其余表都存在 1 对 1、1 对多或多对多的关系时，可分割表，按照映射关系把表 3 中的每一行内嵌到对应的表中。当查询表 1 或 2 中的某行时就能得到同这一行所关联的所有表 3 的数据，避免表 3 同其余与之有联系的所有表之间的连接查询。

| Goods 表 | Goods 表  | Goods 表  |
| -------- | --------- | --------- |
| GoodsId  | GoodsName | PictureId |
| 1        | 桌子      | 1         |
| 2        | 椅子      | 2         |

| Goods 表 | Goods 表  | Goods 表  |
| -------- | --------- | --------- |
| brandId  | brandName | PictureId |
| 1        | 水星      | 3         |
| 2        | 宜家      | 4         |

| Picture 表 | Picture 表  |
| ---------- | ----------- |
| PictureId  | Picturesize |
| 1          | 50kb        |
| 2          | 41kb        |
| 3          | 80kb        |
| 4          | 14kb        |

| Goods 表 | Goods 表   | Goods 表       | Goods 表                       |
| -------- | ---------- | -------------- | ------------------------------ |
| 行键     | Goods 列族 | Goods 列族     | picture 列族                   |
| 1        | GoodsId=1  | GoodsName=桌子 | PictureId=1 ；Picturesize=50kb |
| 2        | GoodsId=2  | GoodsName=椅子 | PictureId=2；Picturesize=41kb  |

| Goods 表 | Goods 表   | Goods 表       | Goods 表                       |
| -------- | ---------- | -------------- | ------------------------------ |
| 行键     | brand 列族 | brand 列族     | picture 列族                   |
| 1        | brandId=1  | brandName=水星 | PictureId=3 ；Picturesize=80kb |
| 2        | brandId=2  | brandName=宜家 | PictureId=4；Picturesize=14kb  |

### 5.5.4 内联变换

适用场景

从表 1 到表 2 存在 1 对 1、1 对多或多对多关系，且表 2 到表 3 也存在这些关系时，把表 3 作为表 1 的内联表。当查询表 1 中的某一行时，得到同这一行通过表 2 所间接关联的所有表 3 中的数据，这样就可以避免表 1、表 2 和表 3 这三张表之间的连接查询。

- 方法
- 表 1:Goods(主表)、表 2:Model、表 3:GoodsRelated。
- 把表 3 中所有同表 1 这一行通过表 2 有间接关联的所有行属性都放入到列族 2 中。

| Goods 表 | Goods 表  |
| -------- | --------- |
| GoodsId  | GoodsName |
| 1        | 桌子      |
| 2        | 椅子      |

| Model 表 | Model 表 | Model 表  |
| -------- | -------- | --------- |
| ModelId  | GoodsId  | ModelName |
| 1        | 1        | 方型桌子  |
| 2        | 1        | 圆形桌子  |
| 3        | 3        | 长板凳    |

| goodsRelated 表 | goodsRelated 表 | goodsRelated 表 |
| --------------- | --------------- | --------------- |
| ModelId         | goodsRelatedId  | Price           |
| 1               | 1               | 1000            |
| 2               | 2               | 600             |
| 3               | 3               | 200             |

| Goods 表 | Goods 表   | Goods 表       | Goods 表                     | Goods 表                    |
| -------- | ---------- | -------------- | ---------------------------- | --------------------------- |
| 行键     | Goods 列族 | Goods 列族     | goodsRelated 列族            | goodsRelated 列族           |
| 1        | GoodsId=1  | GoodsName=桌子 | goodsRelatedId=1；price=1000 | goodsRelatedId=3；price=600 |
| 2        | GoodsId=2  | GoodsName=椅子 | goodsRelatedId=1；price=200  |                             |

### 5.5.5 小结

上述几种表模式转换方式，分别适用不同的场景，解决了关系数据库中各个主键、外键之间的依赖，从而能将关系数据库中各个互相关联的数据拆分开来存储到 HBASE 当中，而且不会打乱他们之间的依赖关系。因此值得借鉴，在表处理模块当中，我们使用上述的表模式转换处理方式，将从关系数据库中读出的数据成拆分并存入中间文件当中，从而使存表模块能直接读取中间文件当中的数据来进行同步而不需要关心关系数据库当中数据到底是什么样子。很好的实现了解耦。

## 5.6 具体实现

本工具采用 Java 语言进行开发，并在开发过程中并未使用任何 Java 框架，一方面是因为本身工具功能简单，并不需要框架进行管理；另一方面：原生的语言会在处理小问题的时候更加快速和高效。

### 5.6.1 技术方案选择

- 选择语言：Java
- 关系数据库：MySQL, sqlserver, Oracle
- HBASE: hadoop 进行管理
- 数据库的连接和管理：标准 JDBC 和 ODBC
- HBASE：连接和使用：HBASE 的 Java API

### 5.6.2 文件设计

配置文件设计：

采用 XML 格式的配置文件，原因如下：

XML 格式每个数据均在数据元中，这样在作为配置文件的格式时，我们只需要注意每个元是什么即可，其他方面一律不用关心，这样极大的提高了容错性。而且结构化的语法很便于用户配置和读写。

配置文件样式：

```
<?xml version="1.0" encoding="GB2312"?>
                             <config>
                             <RDB>
                             <type> </type>
                             <address></address>
                             <username> </username>
                             <password></password>
                             <databases>
                             <database>
                             <name> </name>
                             <tables>
                             <table>
                             <tablename> </tablename>
                             <sync>Merchant</sync>
                             <timespace></timespace>
                             </table>
                             </tables>
                             </database>
                             </databases>
                             </RDB>
                             <HBASE>
                             <address></address>
                             <username> </username>
                             <password></password>
                             </HBASE>
                             </config>
```

## 5.7 其他性能和管理问题具体实现

### 5.7.1 关系数据库连接维护、中断续传、缓存问题、中间文件

问题描述：

- 1：数据库连接中断或者连接不上，网络故障导致的无法连接。
- 2：同步遇到故障导致同步进行到一半的处理方法
- 3：中间文件日志表的备份和删除处理

解决方案：

1：当遇到数据库连接故障，记录进系统日志并立即重试。并在控制台进行故障和原因输出，要求用户检查网络或者数据库配置。如果一直未成功，终止程序并记录日志。

2：由于工具采用的是中间文件同步方式，每个中间文件有大小限制（100 万条数据为界限），如果同步中断，则保存下最后一条同步处的信息，在下次的时候，再次读取中间文件到上次记录的位置进行同步。

3：每个中间文件同步完成之后，备份到其他目录并删除这个中间文件。

### 5.7.2 错误控制

| 错误类型         | 原因                               | 解决办法                                       |
| ---------------- | ---------------------------------- | ---------------------------------------------- |
| 数据库连接错误   | 数据库设置不正确或者数据库本身出错 | 取消本次操作，报告错误，并让用户修正错误后重试 |
| 用户参数输入错误 | 输入参数不规范                     | 取消本次操作并提醒用户重试                     |
| 其他操作错误     | 用户不正当操作造成的错误           | 取消本次操作并提醒用户正确的操作               |
| 未知错误         | 未知异常                           | 记录日志，并提醒用户重启或者联系维护人员       |

# 六、Hbase 与关系数据库同步工具的软件测试

本章将对 Hbase 与关系数据库同步工具进行软件测试。在本章的软件测试工作，主要分为两个部分进行，分别是系统功能测试和系统性能测试。在功能测试中主要结合测试用例对需求分析中的各个功能需求进行测试；在性能测试中则主要集中对数据处理速率和可靠性等性能进行测试，并结合测试结果进行了分析总结。

## 6.1 测试环境

在 Hbase 与关系数据库同步工具软件的测试中，将结合现有的关系数据库和 HBASE，对本论文研究的 Hbase 与关系数据库同步工具的功能需求实现情况进行测试。

测试的物理结构如图：

[![img](https://www.writebug.com/myres/static/uploads/2022/5/29/241422d05efe074ede3a5849db2fea20.writebug)](https://www.writebug.com/office/imagePreview?imgurl=https://www.writebug.com/myres/static/uploads/2022/5/29/241422d05efe074ede3a5849db2fea20.writebug)

- 图 6-1 测试物理结构图
- 具体的测试硬件环境表 6-1 所示
- 表 6-1 测试硬件环境列表

| 硬件名称                   | 配置信息                                                     | 其它说明                                                     |
| -------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| ；HBase 服务器；（1 台）； | CPU: 8 核；；硬盘：500GB；内存：8GB；                        | 该服务器作为 HBASE 数据的存储方，提供 HBASE 存储需要的一切条件 ； |
| 日志数据源测试包           | Cintel 公司自行研发的数据库模拟装，能对数据库进行性能测试和压力测试 | ；                                                           |
| PC 机（1 台）              | CPU：Intel Core i52.66GHZ； 2 颗，每颗 8 核；硬盘：256GB ；内存：8GB； | Pc 机用于运行该程序，并观察各种文件和日志的生成、读写情况    |

在表 6-2 中同样列出了软件测试的软件环境：

表 6-2 测试软件环境列表

| 软件类型       | 软件信息                   |
| -------------- | -------------------------- |
| 服务器操作系统 | MAC OS 10                  |
| Hadoop         | Hadoop 2.6.0               |
| HBase          | HBase 0.98.10.1            |
| JDK            | JDK 8                      |
| PC 操作系统    | MAC OS 10                  |
| 被测系统       | Hbase 与关系数据库同步工具 |

## 6.2 关系数据库到 HBASE 数据同步工具的功能测试

在本节将对基于 Flume 的日志采集系统的 5 个主要功能用例进行测试，用例的测试的真确与否即反应了后台采集子系统在自动采集、分类采集、数据筛选等功能上的实现情况，也反应了前端交互子系统在可视化和采集结果快捷访问等功能需求的实现效果。下面是对系统功能的测试情况：

表 6-3 功能测试情况列表

| 测试用例对象       | 测试用例数 | 测试结果 |
| ------------------ | ---------- | -------- |
| 配置文件读取       | 20         | 全部通过 |
| 文件夹和文件初始化 | 10         | 全部通过 |
| 触发器添加         | 50         | 全部通过 |
| 中间文件生成       | 20         | 全部通过 |
| HBASE 数据同步     | 20         | 全部通过 |

表 6-4 功能测试用例列表

| 用例编号 | 测试目的           | 测试描述                                                     |
| -------- | ------------------ | ------------------------------------------------------------ |
| 1        | 配置文件配置和读取 | 输入：配置文件 XML 文件；预期结果：；读取出来配置文件中的所有配置信息 |
| 2        | 文件夹和文件初始化 | 输入：无；预期结果：在以数据库地址为名字的文件夹下，生成 logTable, middleFile, toHbaseLog, logTable, 并在他们下面生成同名的 txt 文件 |
| 3        | 触发器添加         | 输入：配置文件信息；预期结果： 在目标关系数据库的相应表上添加三个触发器，分别监控插入、更新、删除这三个动作； |
| 4        | 中间文件生成       | 输入：日志表文件；预期结果：；读取日志表文件中的数据，根据数据读取数据库数据。；将数据进行处理，存入中间文件 |
| 5        | HBASE 数据同步     | 输入：中间文件；预期结果：；存入 HBASE。；生成日志。         |

以下是成果汇报中的测试用例执行情况示意图：

[![img](https://www.writebug.com/myres/static/uploads/2022/5/29/78f8a6f963270b8e63fd55fb68fdd568.writebug)](https://www.writebug.com/office/imagePreview?imgurl=https://www.writebug.com/myres/static/uploads/2022/5/29/78f8a6f963270b8e63fd55fb68fdd568.writebug)

[![img](https://www.writebug.com/myres/static/uploads/2022/5/29/88f08653a1a6aa92c60b899ab764a453.writebug)](https://www.writebug.com/office/imagePreview?imgurl=https://www.writebug.com/myres/static/uploads/2022/5/29/88f08653a1a6aa92c60b899ab764a453.writebug)

[![img](https://www.writebug.com/myres/static/uploads/2022/5/29/1d42bac5f104385912e6b0e04320eb61.writebug)](https://www.writebug.com/office/imagePreview?imgurl=https://www.writebug.com/myres/static/uploads/2022/5/29/1d42bac5f104385912e6b0e04320eb61.writebug)

[![img](https://www.writebug.com/myres/static/uploads/2022/5/29/0dcd040db32742d7c84b40fd8faf289a.writebug)](https://www.writebug.com/office/imagePreview?imgurl=https://www.writebug.com/myres/static/uploads/2022/5/29/0dcd040db32742d7c84b40fd8faf289a.writebug)

[![img](https://www.writebug.com/myres/static/uploads/2022/5/29/02c5b8ff465d15b974e7a73b043e4913.writebug)](https://www.writebug.com/office/imagePreview?imgurl=https://www.writebug.com/myres/static/uploads/2022/5/29/02c5b8ff465d15b974e7a73b043e4913.writebug)

[![img](https://www.writebug.com/myres/static/uploads/2022/5/29/660a4e4bc1e137d719304f979e692500.writebug)](https://www.writebug.com/office/imagePreview?imgurl=https://www.writebug.com/myres/static/uploads/2022/5/29/660a4e4bc1e137d719304f979e692500.writebug)

## 6.3 关系数据库到 HBASE 数据同步工具的性能测试

### 6.3.1 吞吐率测试

在吞吐率测试中，为了使测试结果更加的准确,使用 cintel 公司的模拟装，并在每次测试的时候，利用工具自己生成系统时间，这样就可以获得采集一定数据量的日志数据所需要的精确时间，从而计算出系统实际的吞吐率。根据上述测试设计，测试结果如下表 6-5：

表 6-5 吞吐率测试情况列表

| 目标采集量；（万条） | 开始时间     | 结束时间     | 总时间；(s) | 吞吐率；（万条/s） |
| -------------------- | ------------ | ------------ | ----------- | ------------------ |
| 1                    | 16:28:4.648  | 16:28:11.509 | 6.861       | 1.46               |
| 5                    | 17:13:33.540 | 17:13:57.320 | 23.780      | 2.10               |
| 10                   | 17:32:7.219  | 17:32:41.976 | 34.757      | 2.88               |
| 20                   | 17:48:56.305 | 17:50:3.892  | 67.589      | 2.95               |

### 6.3.2 可靠性测试

对于可靠性的测试，就是测试本系统同步的准确率，即在整个同步过程中有没有存在数据记录丢失的情况。在本论文中对该性能的测试方法是对中间文件进行备份，并在工具内部设置记录标志，同步完成后查看中间文件和记录标志，这样一对比就可以计算出同步的准确率。根据上述设计，测试结果如下表 6-6：

表 6-6 可靠性测试情况列表

| 目标采集量（万条） | 成功采集量（万条） | 准确率 |
| ------------------ | ------------------ | ------ |
| 1                  | 1                  | 100%   |
| 5                  | 5                  | 100%   |
| 10                 | 10                 | 100%   |
| 20                 | 20                 | 100%   |

## 6.4 测试总结

通过上述对于关系数据库到 HBASE 数据同步工具的软件测试可以发现，在功能测试方面对每个测试用例，都得到预测的结果和效果；在性能测试方面，当采集量达到一定的量，本系统的日志记录采集的吞吐率将维持在 20000 条/s 以上，而且在没有宕机等故障的情况下采集的准确率为 100%，即在系统运行正常时具有极高的可靠性。从而，从上述测试结果中可以得出结论，本次项目的开发与实现基本符合需求和预期目标。

# 七、结束语

## 7.1 论文工作总结

关系数据库到 HBASE 数据同步工具研究了对于关系数据库的变化捕捉和到 HBASE 同步的实现策略。在充分调研和学习已有方案和别人的成熟解决方式之后，完善了前人并未完善的细节并重新设计一个单独的只做关系数据库到 HBASE 的单向、增量同步工具，从而作为 sqoop、flume 等工具的良好补充，并对兼容性、稳定性、和移植性做了很好的处理，从而满足不同用户的需求。并在考虑网络适应性和中断继续处理、缓存等方面进行了设计，具有良好的性能。

然而，在本课题的研究中尚存在许多不足之处，包括：

该工具做变化捕捉的时候，会在目标关系数据库中建立一张新的变更日志表，用于存储变更信息方便之后读取相关数据。但是我们不知道在目标数据库中表的分布到底是什么样子，会不会造成污染等等。目前的办法就是给日志表起一个尽量不会重复的名称，同时不和之外而表有任何的依赖。这样尽量保证日志表的可用性。

本工具中因为采用的是 JDBC 连接数据库，所以在数据库连接和触发器插入的阶段，需要对三种不同的数据库进行不同的代码书写，这样造成了代码量的激增，同时代码重复也使得代码不易于维护和查看。虽然已经有了 hibernate 这种数据库工具，但是为了工具的轻巧和依赖少，在这个工具当中并没有使用。关于如何减少代码量和复用问题，之后有待进一步研究。。

本工具每次对关系数据库和 HBASE 只能连接一个，并不能进行集群的管理和同步。而 HBASE 经常是存储海量文件的，因此基本是以集群出现，但是本工具并没有实现这个功能。对集群的管理和控制需要在之后进行进一步的研究和学习。

本工具只做了从关系数据库到 HBASE 的单向、增量同步，因为市面上已经有对其他同步、导出问题的解决方案。因此本工具在使用的时候，需要配合其他工具如 sqoop 一起使用，先用 sqoop 进行数据导出，然后再用本工具进行监控同步。最好的方案是将本工具所依赖的其他工具集成到工具里面，这样就可以每次需要使用的时候，一键就可以完成所有的工作。但是受限于自身水平等原因，这个问题还有待进一步研究。和解决。

因此，虽然毕业设计已接近尾声，并在研究过程中取得了一定的成果，但对于关系数据库到 HBASE 的同步工具仍然有很多需要完善的地方、需要进行进一步的研究。以本阶段的学习情况以及以上总结出的几点不足之处为基础，相新会对我未来的工作、学习有很大启发，让我在服务设计和软件开发的具体实现上有更多的进步。

参考文献

者敬,开放式异构数据库复制框架的研究与实现,中国科学院软件研究所博士学位论文,2004

蒋敏,基于网络隔离的异构数据库同步技术的研究与实现,浙江大学硕士学位论文,2006

沈敏,许华虎,季永华等,基于 XML 的分布式异构数据库数据同步系统的研究,计算机工程与应用,2005,41(5):184 一 186

杨鹏，异构数据库同步中间件技术的研究与实现，国防科大研究生论文，2007

陈吉荣基于 MapReduce 的 Hadoop 大表导入编程模型,东华大学计算机科学与技术学院,2013

冯晓普北京邮电大学，计算机科学与技术硕士论文，2014

Anthony Molinaro,SQL Cookbook 2006 Guy Harrison, Steven Feuerstein, MySQL Stored Procedure Programming, 2006

明日科技 SQL Server 从入门到精通(附光盘)，2012

明日科技 Oracle 从入门到精通(Oracle 11g)(附光盘)，2012

施瓦茨 (Baron Schwartz) (作者), 扎伊采夫 (Peter Zaitsev) (作者), 特卡琴科 (Vadim Tkachenko) (作者), 宁海元 (译者), 周振兴 (译者), 彭立勋 (译者), 翟卫祥 (译者), 等 (译者)，高性能 MySQL(第 3 版)，2013

乔治 (Lars George) (作者), 代志远 (译者), 刘佳 (译者), 蒋杰 (译者)，HBase 权威指南，2013

怀特 (Tom White) (作者), 华东师范大学数据科学与工程学院 (译者)，Hadoop 权威指南(第 3 版)(修订版)

埃史尔 (作者), 陈昊鹏 (译者)，Java 编程思想(第 4 版)，2007

XinYingxiu，Research andApplication ofSynchronization UpdateofDistributed Heterogeneous Database，

田淼，分布式异构数据库同步中间件的设计与实现西安电子科技大学 2012

胡金龙,许卫,房福龙,李刚,曹晓宁 Synchronous Replication Technology of Heterogeneous Database and Its Application 2011

Yubiao Wang,Xibin Wang, An Heterogeneous Database Synchronization Update base on Web Services. 2012

Zhenyou ZHANG Cuifang LU，Research and Implementation for Data Synchronization of Heterogeneous Databases. 2013

# 八、致 谢

在毕业设计论文即将完成之际，我的大学四年本科学习也即将结束。在此，我要向所有关心、支持、帮助过我的老师、家人、同学和朋友致以最真诚的感谢。

首先要想指导老师王红熳表示诚挚的感谢。感谢她将我从一个数据库领域的门外汉，变成了一个初学者和好学者，让我有机会一窥大数据领域的深奥。也感谢她在整个毕设工作中的正确的引导和细心指导，使我在这次毕设工作中在知识积累、研究方法、工作作风等方面都受益匪浅。

同样感谢赵以旭学长从介绍项目背景，到确定项目需求，以及项目实现过程中方方面面上的帮助和指导。

感谢上海欣方智能有限公司的陈栋波等学长学姐，感谢他们在我整个毕设工作中众多关键问题上的建议与帮助。

同时要感谢与我一起参与毕设工作的赵晓琪、包晓芳、张梦琪、何乔同学，他们是优秀的合作者。正是由于与他们之间的互帮互助才使得这次毕设工作在充实与欢乐中圆满完成。

最后向大家致敬。

# 九、附　　录

## 9.1 附录 1 英文缩略语对照表

| 英文缩写 | 英文全称                   | 中文释义        |
| -------- | -------------------------- | --------------- |
| RDBS     | Relational database        | 关系型数据库    |
| JDBC     | Java Database Connectivity | Java 数据库连接 |
| ODBC     | Open Database Connectivity | 开放数据库互连  |