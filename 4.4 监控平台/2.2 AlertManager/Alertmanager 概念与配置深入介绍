- [Alertmanager æ¦‚å¿µä¸é…ç½®æ·±å…¥ä»‹ç»](https://www.cnblogs.com/sanduzxcvbnm/p/14247590.html)

æ–‡ç« è½¬è½½è‡ªï¼šhttps://www.cnblogs.com/gered/p/13496950.html

è­¦æŠ¥ä¸€ç›´æ˜¯æ•´ä¸ªç›‘æ§ç³»ç»Ÿä¸­çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼ŒPrometheusç›‘æ§ç³»ç»Ÿä¸­ï¼Œé‡‡é›†ä¸è­¦æŠ¥æ˜¯åˆ†ç¦»çš„ã€‚
 æŠ¥è­¦è§„åˆ™åœ¨ Prometheus å®šä¹‰ï¼Œè­¦æŠ¥è§„åˆ™è§¦å‘ä»¥åï¼Œæ‰ä¼šå°†ä¿¡æ¯è½¬å‘åˆ°ç»™ç‹¬ç«‹çš„ç»„ä»¶Alertmanager ï¼Œç»è¿‡  Alertmanagerå¯¹è­¦æŠ¥çš„ä¿¡æ¯å¤„ç†åï¼Œæœ€ç»ˆé€šè¿‡æ¥æ”¶å™¨å‘é€ç»™æŒ‡å®šç”¨æˆ·ï¼Œå¦å¤–åœ¨ Alertmanager  ä¸­æ²¡æœ‰é€šçŸ¥ç»„çš„æ¦‚å¿µï¼Œåªèƒ½è‡ªå·±å¯¹è½¯ä»¶é‡æ–°Codingï¼Œæˆ–è€…ä½¿ç”¨ç¬¬ä¸‰æ–¹æ’ä»¶æ¥å®ç°ã€‚
 æ³¨æ„ï¼Œè¿™ä¸ªé€šçŸ¥ç»„ä¸æ˜¯Alertmanagerä¸­çš„groupæ¦‚å¿µï¼Œä¸‹é¢ä¼šè¯¦ç»†è®² Group ï¼Œä¸è¦æ··æ·†å“¦ã€‚

å‰é¢å·²ç»ä»‹ç»è¿‡ä¸€äº›å…³äº Alertmanager çŸ¥è¯†ç‚¹ï¼Œæœ¬ç« å¼€å§‹é’ˆé€šè¿‡å®‰è£… Alertmanager  ç»„ä»¶ï¼Œå¯¹é…ç½®æ–‡ä»¶åšè¯¦ç»†è¯´æ˜ï¼ŒåŒæ—¶ä»‹ç» Prometheus  çš„è­¦æŠ¥è§„åˆ™çš„å®šä¹‰ï¼Œæœ€åä½¿ç”¨Emailã€Wechatï¼ˆRobotï¼‰ã€Dingtalkï¼ˆwebhookï¼‰æ¥æ¥å—è­¦æŠ¥é€šçŸ¥ã€‚

# Alertmanagerå·¥ä½œæœºåˆ¶

![img](https://img2020.cnblogs.com/blog/794174/202101/794174-20210107165553732-1891472365.png)

åœ¨Prometheusç”Ÿæ€æ¶æ„é‡Œï¼Œè­¦æŠ¥æ˜¯ç”±ç‹¬ç«‹çš„ä¿©éƒ¨åˆ†ç»„æˆï¼Œå¯ä»¥é€šè¿‡ä¸Šå›¾å¾ˆæ¸…æ™°çš„äº†è§£åˆ° Prometheus çš„è­¦æŠ¥å·¥ä½œæœºåˆ¶ã€‚
 å…¶ä¸­ Prometheus ä¸ Alertmanager æ˜¯åˆ†ç¦»çš„ä¿©ä¸ªç»„ä»¶ã€‚
 ä½¿ç”¨Prometheus Serverç«¯é€šè¿‡é™æ€æˆ–è€…åŠ¨æ€é…ç½®å»æ‹‰å– pull éƒ¨ç½²åœ¨k8sæˆ–äº‘ä¸»æœºä¸Šçš„å„ç§ç±»åˆ«çš„ç›‘æ§æŒ‡æ ‡æ•°æ®ï¼Œç„¶ååŸºäº  PromQL å¯¹è¿™äº›å·²ç»å­˜å‚¨åœ¨æœ¬åœ°å­˜å‚¨ HDD/SSD çš„ TSDB ä¸­çš„æŒ‡æ ‡å®šä¹‰é˜ˆå€¼è­¦æŠ¥è§„åˆ™ Rules  ã€‚Prometheusä¼šæ ¹æ®é…ç½®çš„å‚æ•°å‘¨æœŸæ€§çš„å¯¹è­¦æŠ¥è§„åˆ™è¿›è¡Œè®¡ç®—ï¼Œå¦‚æœæ»¡è¶³è­¦æŠ¥æ¡ä»¶ï¼Œç”Ÿäº§ä¸€æ¡è­¦æŠ¥ä¿¡æ¯ï¼Œå°†å…¶æ¨é€åˆ° Alertmanager  ç»„ä»¶ï¼ŒAlertmanager æ”¶åˆ°è­¦æŠ¥ä¿¡æ¯ä¹‹åï¼Œä¼šå¯¹è­¦å‘Šä¿¡æ¯è¿›è¡Œå¤„ç†ï¼Œè¿›è¡Œ åˆ†ç»„ Group å¹¶å°†å®ƒä»¬é€šè¿‡å®šä¹‰å¥½çš„è·¯ç”± Routing  è§„åˆ™è½¬åˆ° æ­£ç¡®çš„æ¥æ”¶å™¨ receiverï¼Œæ¯”å¦‚ Email Slack é’‰é’‰ã€ä¼ä¸šå¾®ä¿¡ Robotï¼ˆwebhookï¼‰ ä¼ä¸šå¾®ä¿¡ ç­‰ï¼Œæœ€ç»ˆå¼‚å¸¸äº‹ä»¶ Warningã€Erroré€šçŸ¥ç»™å®šä¹‰å¥½çš„æ¥æ”¶äººï¼Œå…¶ä¸­å¦‚é’‰é’‰æ˜¯åŸºäºç¬¬ä¸‰æ–¹é€šçŸ¥æ¥å®ç°çš„ï¼Œå¯¹äºé€šçŸ¥äººå®šä¹‰æ˜¯åœ¨é’‰é’‰çš„ç¬¬ä¸‰æ–¹ç»„ä»¶ä¸­é…ç½®ã€‚

åœ¨ Prometheus ä¸­ï¼Œä¸ä»…ä»…å¯ä»¥å¯¹å•æ¡è­¦æŠ¥è¿›è¡Œå‘½åé€šè¿‡  PromQLå®šä¹‰è§„åˆ™ï¼Œæ›´å¤šæ—¶å€™æ˜¯å¯¹ç›¸å…³çš„å¤šæ¡è­¦æŠ¥è¿›è¡Œåˆ†ç»„åç»Ÿä¸€å®šä¹‰ã€‚è¿™äº›å®šä¹‰ä¼šåœ¨åé¢è¯´æ˜ä¸å…¶ç®¡ç†æ–¹æ³•ã€‚ä¸‹é¢å¼€å§‹æŠŠ Alertmanager  ä¸­çš„åˆ†ç»„ Grouping ã€æŠ‘åˆ¶ Inhibitionã€å»¶è¿Ÿ Silences
 æ ¸å¿ƒç‰¹æ€§è¿›è¡Œä»‹ç»ï¼Œä¾¿äºå¤§å®¶ç³»ç»Ÿæ€§çš„å­¦ä¹ ä¸ç†è§£ã€‚

# AlertManagerçš„ä¸‰ä¸ªæ¦‚å¿µ

## åˆ†ç»„ï¼ˆGroupingï¼‰

`Grouping` æ˜¯ **Alertmanager**  æŠŠåŒç±»å‹çš„è­¦æŠ¥è¿›è¡Œåˆ†ç»„ï¼Œåˆå¹¶å¤šæ¡è­¦æŠ¥åˆ°ä¸€ä¸ªé€šçŸ¥ä¸­ã€‚åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œç‰¹åˆ«æ˜¯äº‘ç¯å¢ƒä¸‹çš„ä¸šåŠ¡ä¹‹é—´å¯†é›†è€¦åˆæ—¶ï¼Œè‹¥å‡ºç°å¤šå° Instance  æ•…éšœï¼Œå¯èƒ½ä¼šå¯¼è‡´æˆåƒä¸Šç™¾æ¡è­¦æŠ¥è§¦å‘ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ä½¿ç”¨åˆ†ç»„æœºåˆ¶ï¼Œ  å¯ä»¥æŠŠè¿™äº›è¢«è§¦å‘çš„è­¦æŠ¥åˆå¹¶ä¸ºä¸€ä¸ªè­¦æŠ¥è¿›è¡Œé€šçŸ¥ï¼Œä»è€Œé¿å…ç¬é—´çªå‘æ€§çš„æ¥å—å¤§é‡è­¦æŠ¥é€šçŸ¥ï¼Œä½¿å¾—ç®¡ç†å‘˜æ— æ³•å¯¹é—®é¢˜è¿›è¡Œå¿«é€Ÿå®šä½ã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œåœ¨Kubernetesé›†ç¾¤ä¸­ï¼Œè¿è¡Œç€é‡é‡çº§è§„æ¨¡çš„å®ä¾‹ï¼Œå³ä¾¿æ˜¯é›†ç¾¤ä¸­æŒç»­å¾ˆå°ä¸€æ®µæ—¶é—´çš„ç½‘ç»œå»¶è¿Ÿæˆ–è€…å»¶è¿Ÿå¯¼è‡´ç½‘ç»œæŠ–åŠ¨ï¼Œä¹Ÿä¼šå¼•å‘å¤§é‡ç±»ä¼¼æœåŠ¡åº”ç”¨æ— æ³•è¿æ¥ `DB` çš„æ•…éšœã€‚å¦‚æœåœ¨è­¦æŠ¥è§„åˆ™ä¸­å®šä¹‰æ¯ä¸€ä¸ªåº”ç”¨å®ä¾‹éƒ½å‘é€è­¦æŠ¥ï¼Œé‚£ä¹ˆåˆ°æœ€åçš„ç»“æœå°±æ˜¯ ä¼šæœ‰å¤§é‡çš„è­¦æŠ¥ä¿¡æ¯å‘é€ç»™ **Alertmanager** ã€‚

ä½œä¸ºè¿ç»´ç»„æˆ–è€…ç›¸å…³ä¸šåŠ¡ç»„çš„å¼€å‘äººå‘˜ï¼Œå¯èƒ½æ›´å…³å¿ƒçš„æ˜¯åœ¨ä¸€ä¸ªé€šçŸ¥ä¸­å°±å¯ä»¥å¿«é€ŸæŸ¥çœ‹åˆ°å“ªäº›æœåŠ¡å®ä¾‹è¢«æœ¬æ¬¡æ•…éšœå½±å“äº†ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯¹æœåŠ¡æ‰€åœ¨é›†ç¾¤æˆ–è€…æœåŠ¡è­¦æŠ¥åç§°çš„ç»´åº¦è¿›è¡Œåˆ†ç»„é…ç½®ï¼ŒæŠŠè­¦æŠ¥æ±‡æ€»æˆä¸€æ¡é€šçŸ¥æ—¶ï¼Œå°±ä¸ä¼šå—åˆ°è­¦æŠ¥ä¿¡æ¯çš„é¢‘ç¹å‘é€å½±å“äº†ã€‚

## æŠ‘åˆ¶ï¼ˆInhibitionï¼‰

`Inhibition` æ˜¯ å½“æŸæ¡è­¦æŠ¥å·²ç»å‘é€ï¼Œåœæ­¢é‡å¤å‘é€ç”±æ­¤è­¦æŠ¥å¼•å‘çš„å…¶ä»–å¼‚å¸¸æˆ–æ•…éšœçš„è­¦æŠ¥æœºåˆ¶ã€‚åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼ŒIDCæ‰˜ç®¡æœºæŸœä¸­ï¼Œè‹¥æ¯ä¸€ä¸ªæœºæŸœæ¥å…¥å±‚ä»…ä»…æ˜¯å•å°äº¤æ¢æœºï¼Œé‚£ä¹ˆè¯¥æœºæŸœæ¥å…¥äº¤æ¢æœºæ•…éšœä¼šé€ æˆæœºæŸœä¸­æœåŠ¡å™¨é `up` çŠ¶æ€è­¦æŠ¥ã€‚å†æœ‰æœåŠ¡å™¨ä¸Šéƒ¨ç½²çš„åº”ç”¨æœåŠ¡ä¸å¯è®¿é—®ä¹Ÿä¼šè§¦å‘è­¦æŠ¥ã€‚
 è¿™æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡åœ¨ **Alertmanager** é…ç½®å¿½ç•¥ç”±äºäº¤æ¢æœºæ•…éšœè€Œé€ æˆçš„æ­¤æœºæŸœä¸­çš„æ‰€æœ‰æœåŠ¡å™¨åŠå…¶åº”ç”¨ä¸å¯è¾¾è€Œäº§ç”Ÿçš„è­¦æŠ¥ã€‚

åœ¨æˆ‘ä»¬çš„ç¾å¤‡ä½“ç³»ä¸­ï¼Œå½“åŸæœ‰é›†ç¾¤æ•…éšœå®•æœºä¸šåŠ¡å½»åº•æ— æ³•è®¿é—®çš„æ—¶å€™ï¼Œä¼šæŠŠç”¨æˆ·æµé‡åˆ‡æ¢åˆ°å¤‡ä»½é›†ç¾¤ä¸­ï¼Œè¿™æ ·ä¸ºæ•…éšœé›†ç¾¤åŠå…¶æä¾›çš„å„ä¸ªå¾®æœåŠ¡çŠ¶æ€å‘é€è­¦æŠ¥æœºä¼šå¤±å»äº†æ„ä¹‰ï¼Œæ­¤æ—¶ï¼Œ **Alertmanager** çš„æŠ‘åˆ¶ç‰¹æ€§å°±å¯ä»¥åœ¨ä¸€å®šç¨‹åº¦ä¸Šé¿å…ç®¡ç†å‘˜æ”¶åˆ°è¿‡å¤šæ— ç”¨çš„è­¦æŠ¥é€šçŸ¥ã€‚

## é™é»˜ï¼ˆ`Silences` ï¼‰

`Silences` æä¾›äº†ä¸€ä¸ªç®€å•çš„æœºåˆ¶ï¼Œæ ¹æ®æ ‡ç­¾å¿«é€Ÿå¯¹è­¦æŠ¥è¿›è¡Œé™é»˜å¤„ç†ï¼›å¯¹ä¼ è¿›æ¥çš„è­¦æŠ¥è¿›è¡ŒåŒ¹é…æ£€æŸ¥ï¼Œå¦‚æœæ¥å—åˆ°è­¦æŠ¥ç¬¦åˆé™é»˜çš„é…ç½®ï¼Œ**Alertmanager** åˆ™ä¸ä¼šå‘é€è­¦æŠ¥é€šçŸ¥ã€‚

ä»¥ä¸Šé™¤äº†åˆ†ç»„ã€æŠ‘åˆ¶æ˜¯åœ¨ **Alertmanager** é…ç½®æ–‡ä»¶ä¸­é…ç½®ï¼Œé™é»˜æ˜¯éœ€è¦åœ¨ WEB UI ç•Œé¢ä¸­è®¾ç½®ä¸´æ—¶å±è”½æŒ‡å®šçš„è­¦æŠ¥é€šçŸ¥ã€‚

> ä»¥ä¸Šçš„æ¦‚å¿µéœ€è¦å¥½å¥½ç†è§£ï¼Œè¿™æ ·æ‰å¯ä»¥è½»æ¾çš„åœ¨ç›‘æ§ç³»ç»Ÿè®¾è®¡çš„æ—¶å€™é’ˆå¯¹è­¦æŠ¥è®¾è®¡çš„ä¸€äº›åœºæ™¯è‡ªè¡Œè°ƒæ•´ã€‚

# å®‰è£…Alertmanager

## äºŒè¿›åˆ¶å®‰è£…

ç”¨ Alertmanager çš„äºŒè¿›åˆ¶å®‰è£…ï¼Œä»¥ systemd ç®¡ç†å¯åŠ¨ã€‚

```
## åˆ›å»ºç›¸å…³ç›®å½•
mkdir -p /data/alertmanager/{bin,conf,logs,data,templates}

## ä¸‹è½½äºŒè¿›åˆ¶åŒ…
wget https://github.com/prometheus/alertmanager/releases/download/v0.21.0/alertmanager-0.21.0.linux-amd64.tar.gz
tar xvf alertmanager-0.21.0.linux-amd64.tar.gz
mv alertmanager-0.21.0.linux-amd64/{alertmanager,amtool} /data/alertmanager/bin/
mv alertmanager-0.21.0.linux-amd64/alertmanager.yml /data/alertmanager/conf/

# ç›®å½•ç»“æ„
/data/alertmanager/
â”œâ”€â”€ bin
â”‚   â”œâ”€â”€ alertmanager
â”‚   â””â”€â”€ amtool
â”œâ”€â”€ conf
â”‚   â””â”€â”€ alertmanager.yml
â”œâ”€â”€ data
â”œâ”€â”€ logs
â””â”€â”€ templates

## åŠ å…¥systemdå¯åŠ¨è„šæœ¬
cat <<EOF >/lib/systemd/system/alertmanager.service
[Unit]
Description=alertmanager
Documentation=https://prometheus.io/
After=network.target
StartLimitIntervalSec=0

[Service]
Type=simple
User=prometheus
ExecStart=/data/alertmanager/bin/alertmanager --storage.path="/data/alertmanager/data/" \
--config.file=/usr/local/alertmanager/alertmanager.yml \
--web.external-url=http://192.168.1.220 # æ­¤å¤„å¯ä»¥å†™åŸŸåï¼Œéœ€è¦åšproxyã€‚
Restart=always
RestartSec=1
# Restart=on-failure

[Install]
WantedBy=multi-user.target
EOF

## å¯åŠ¨
systemctl enable alertmanager
systemctl start alertmanager
```

## Alertmanager å‚æ•°

| å‚æ•°                                                    | æè¿°                                                         |
| ------------------------------------------------------- | ------------------------------------------------------------ |
| `--config.file="alertmanager.yml"`                      | æŒ‡å®šAlertmanageré…ç½®æ–‡ä»¶è·¯å¾„                                 |
| `--storage.path="data/"`                                | Alertmanagerçš„æ•°æ®å­˜æ”¾ç›®å½•                                   |
| `--data.retention=120h`                                 | å†å²æ•°æ®ä¿ç•™æ—¶é—´ï¼Œé»˜è®¤ä¸º120h                                 |
| `--alerts.gc-interval=30m`                              | è­¦æŠ¥gcä¹‹é—´çš„é—´éš”                                             |
| `--web.external-url=WEB.EXTERNAL-URL`                   | å¤–éƒ¨å¯è®¿é—®çš„Alertmanagerçš„URL(ä¾‹å¦‚Alertmanageræ˜¯é€šè¿‡nginxåå‘ä»£ç†) |
| `--web.route-prefix=WEB.ROUTE-PREFIX`                   | wenè®¿é—®å†…éƒ¨è·¯ç”±è·¯å¾„ï¼Œé»˜è®¤æ˜¯ `--web.external-url`             |
| `--web.listen-address=":9093"`                          | ç›‘å¬ç«¯å£ï¼Œå¯ä»¥éšæ„ä¿®æ”¹                                       |
| `--web.get-concurrency=0`                               | å¹¶å‘å¤„ç†çš„æœ€å¤§GETè¯·æ±‚æ•°ï¼Œé»˜è®¤ä¸º0                             |
| `--web.timeout=0`                                       | webè¯·æ±‚è¶…æ—¶æ—¶é—´                                              |
| `--cluster.listen-address="0.0.0.0:9094"`               | é›†ç¾¤çš„ç›‘å¬ç«¯å£åœ°å€ã€‚è®¾ç½®ä¸ºç©ºå­—ç¬¦ä¸²ç¦ç”¨HAæ¨¡å¼                 |
| `--cluster.advertise-address=CLUSTER.ADVERTISE-ADDRESS` | é…ç½®é›†ç¾¤é€šçŸ¥åœ°å€                                             |
| `--cluster.gossip-interval=200ms`                       | å‘é€æ¡æ¶ˆæ¯ä¹‹é—´çš„é—´éš”ï¼Œå¯ä»¥ä»¥å¢åŠ å¸¦å®½ä¸ºä»£ä»·æ›´å¿«åœ°è·¨é›†ç¾¤ä¼ æ’­ã€‚ |
| `--cluster.peer-timeout=15s`                            | åœ¨åŒçº§ä¹‹é—´ç­‰å¾…å‘é€é€šçŸ¥çš„æ—¶é—´                                 |
| ...                                                     | ...                                                          |
| `--log.level=info`                                      | è‡ªå®šä¹‰æ¶ˆæ¯æ ¼å¼ [debug, info, warn, error]                    |
| `--log.format=logfmt`                                   | æ—¥å¿—æ¶ˆæ¯çš„è¾“å‡ºæ ¼å¼: [logfmt, json]                           |
| `--version`                                             | æ˜¾ç¤ºç‰ˆæœ¬å·                                                   |

# Alertmanageré…ç½®è¯¦è§£

## æ¡ˆä¾‹æ¼”ç¤º

```
## Alertmanager é…ç½®æ–‡ä»¶
global:
  resolve_timeout: 5m
  # smtpé…ç½®
  smtp_from: "123456789@qq.com"
  smtp_smarthost: 'smtp.qq.com:465'
  smtp_auth_username: "123456789@qq.com"
  smtp_auth_password: "auth_pass"
  smtp_require_tls: true
# emailã€ä¼ä¸šå¾®ä¿¡çš„æ¨¡æ¿é…ç½®å­˜æ”¾ä½ç½®ï¼Œé’‰é’‰çš„æ¨¡æ¿ä¼šå•ç‹¬è®²å¦‚æœé…ç½®ã€‚
templates:
  - '/data/alertmanager/templates/*.tmpl'
# è·¯ç”±åˆ†ç»„
route:
  receiver: ops
  group_wait: 30s # åœ¨ç»„å†…ç­‰å¾…æ‰€é…ç½®çš„æ—¶é—´ï¼Œå¦‚æœåŒç»„å†…ï¼Œ30ç§’å†…å‡ºç°ç›¸åŒæŠ¥è­¦ï¼Œåœ¨ä¸€ä¸ªç»„å†…å‡ºç°ã€‚
  group_interval: 5m # å¦‚æœç»„å†…å†…å®¹ä¸å˜åŒ–ï¼Œåˆå¹¶ä¸ºä¸€æ¡è­¦æŠ¥ä¿¡æ¯ï¼Œ5måå‘é€ã€‚
  repeat_interval: 24h # å‘é€æŠ¥è­¦é—´éš”ï¼Œå¦‚æœæŒ‡å®šæ—¶é—´å†…æ²¡æœ‰ä¿®å¤ï¼Œåˆ™é‡æ–°å‘é€æŠ¥è­¦ã€‚
  group_by: [alertname]  # æŠ¥è­¦åˆ†ç»„
  routes:
      - match:
          team: operations
        group_by: [env,dc]
        receiver: 'ops'
      - match_re:
          service: nginx|apache
        receiver: 'web'
      - match_re:
          service: hbase|spark
        receiver: 'hadoop'
      - match_re:
          service: mysql|mongodb
        receiver: 'db'
# æ¥æ”¶å™¨
# æŠ‘åˆ¶æµ‹è¯•é…ç½®
      - receiver: ops
        group_wait: 10s
        match:
          status: 'High'
# ops
      - receiver: ops # è·¯ç”±å’Œæ ‡ç­¾ï¼Œæ ¹æ®matchæ¥æŒ‡å®šå‘é€ç›®æ ‡ï¼Œå¦‚æœ ruleçš„lable åŒ…å« alertnameï¼Œ ä½¿ç”¨ ops æ¥å‘é€
        group_wait: 10s
        match:
          team: operations
# web
      - receiver: db # è·¯ç”±å’Œæ ‡ç­¾ï¼Œæ ¹æ®matchæ¥æŒ‡å®šå‘é€ç›®æ ‡ï¼Œå¦‚æœ ruleçš„lable åŒ…å« alertnameï¼Œ ä½¿ç”¨ db æ¥å‘é€
        group_wait: 10s
        match:
          team: db
# æ¥æ”¶å™¨æŒ‡å®šå‘é€äººä»¥åŠå‘é€æ¸ é“
receivers:
# opsåˆ†ç»„çš„å®šä¹‰
- name: ops
  email_configs:
  - to: '9935226@qq.com,10000@qq.com'
    send_resolved: true
    headers:
      subject: "[operations] æŠ¥è­¦é‚®ä»¶"
      from: "è­¦æŠ¥ä¸­å¿ƒ"
      to: "å°ç…œç‹¼çš‡"
  # é’‰é’‰é…ç½®
  webhook_configs:
  - url: http://localhost:8070/dingtalk/ops/send
    # ä¼ä¸šå¾®ä¿¡é…ç½®
  wechat_configs:
  - corp_id: 'ww5421dksajhdasjkhj'
    api_url: 'https://qyapi.weixin.qq.com/cgi-bin/'
    send_resolved: true
    to_party: '2'
    agent_id: '1000002'
    api_secret: 'Tm1kkEE3RGqVhv5hO-khdakjsdkjsahjkdksahjkdsahkj'

# web
- name: web
  email_configs:
  - to: '9935226@qq.com'
    send_resolved: true
    headers: { Subject: "[web] æŠ¥è­¦é‚®ä»¶"} # æ¥æ”¶é‚®ä»¶çš„æ ‡é¢˜
  webhook_configs:
  - url: http://localhost:8070/dingtalk/web/send
  - url: http://localhost:8070/dingtalk/ops/send
# db
- name: db
  email_configs:
  - to: '9935226@qq.com'
    send_resolved: true
    headers: { Subject: "[db] æŠ¥è­¦é‚®ä»¶"} # æ¥æ”¶é‚®ä»¶çš„æ ‡é¢˜
  webhook_configs:
  - url: http://localhost:8070/dingtalk/db/send
  - url: http://localhost:8070/dingtalk/ops/send
# hadoop
- name: hadoop
  email_configs:
  - to: '9935226@qq.com'
    send_resolved: true
    headers: { Subject: "[hadoop] æŠ¥è­¦é‚®ä»¶"} # æ¥æ”¶é‚®ä»¶çš„æ ‡é¢˜
  webhook_configs:
  - url: http://localhost:8070/dingtalk/hadoop/send
  - url: http://localhost:8070/dingtalk/ops/send

# æŠ‘åˆ¶å™¨é…ç½®
inhibit_rules: # æŠ‘åˆ¶è§„åˆ™
  - source_match: # æºæ ‡ç­¾è­¦æŠ¥è§¦å‘æ—¶æŠ‘åˆ¶å«æœ‰ç›®æ ‡æ ‡ç­¾çš„è­¦æŠ¥ï¼Œåœ¨å½“å‰è­¦æŠ¥åŒ¹é… status: 'High'
      status: 'High'  # æ­¤å¤„çš„æŠ‘åˆ¶åŒ¹é…ä¸€å®šåœ¨æœ€ä¸Šé¢çš„routeä¸­é…ç½®ä¸ç„¶ï¼Œä¼šæç¤ºæ‰¾ä¸keyã€‚
    target_match:
      status: 'Warning' # ç›®æ ‡æ ‡ç­¾å€¼æ­£åˆ™åŒ¹é…ï¼Œå¯ä»¥æ˜¯æ­£åˆ™è¡¨è¾¾å¼å¦‚: ".*MySQL.*"
    equal: ['alertname','operations', 'instance'] # ç¡®ä¿è¿™ä¸ªé…ç½®ä¸‹çš„æ ‡ç­¾å†…å®¹ç›¸åŒæ‰ä¼šæŠ‘åˆ¶ï¼Œä¹Ÿå°±æ˜¯è¯´è­¦æŠ¥ä¸­å¿…é¡»æœ‰è¿™ä¸‰ä¸ªæ ‡ç­¾å€¼æ‰ä¼šè¢«æŠ‘åˆ¶ã€‚
```

global

å³ä¸ºå…¨å±€è®¾ç½®ï¼Œåœ¨ Alertmanager é…ç½®æ–‡ä»¶ä¸­ï¼Œåªè¦å…¨å±€è®¾ç½®é…ç½®äº†çš„é€‰é¡¹ï¼Œå…¨éƒ¨ä¸ºå…¬å…±è®¾ç½®ï¼Œå¯ä»¥è®©å…¶ä»–è®¾ç½®ç»§æ‰¿ï¼Œä½œä¸ºé»˜è®¤å€¼ï¼Œå¯ä»¥å­å‚æ•°ä¸­è¦†ç›–å…¶è®¾ç½®ã€‚å…¶ä¸­ resolve_timeout ç”¨äºè®¾ç½®å¤„ç†è¶…æ—¶æ—¶é—´ï¼Œä¹Ÿæ˜¯ç”Ÿå‘½è­¦æŠ¥çŠ¶æ€ä¸ºè§£å†³çš„æ—¶é—´ï¼Œ
 è¿™ä¸ªæ—¶é—´ä¼šç›´æ¥å½±å“åˆ°è­¦æŠ¥æ¢å¤çš„é€šçŸ¥æ—¶é—´ï¼Œéœ€è¦è‡ªè¡Œç»“åˆå®é™…ç”Ÿäº§åœºæ™¯æ¥è®¾ç½®ä¸»æœºçš„æ¢å¤æ—¶é—´ï¼Œé»˜è®¤æ˜¯5åˆ†é’Ÿã€‚åœ¨å…¨å±€è®¾ç½®ä¸­å¯ä»¥è®¾ç½®smtpæœåŠ¡ï¼ŒåŒæ—¶ä¹Ÿæ”¯æŒslackã€victoropsã€pagerdutyç­‰ï¼Œåœ¨è¿™é‡Œåªè®²æˆ‘ä»¬å¸¸ç”¨çš„Emailï¼Œé’‰é’‰ï¼Œä¼ä¸šå¾®ä¿¡ï¼Œ
 åŒæ—¶ä¹Ÿå¯ä»¥è‡ªå·±ä½¿ç”¨goè¯­è¨€å¼€å‘çš„gubotè¿›è¡ŒäºŒæ¬¡å¼€å‘ï¼Œå¯¹æ¥è‡ªå®šä¹‰webhooké€šçŸ¥æºã€‚

template

è­¦æŠ¥æ¨¡æ¿å¯ä»¥è‡ªå®šä¹‰é€šçŸ¥çš„ä¿¡æ¯æ ¼å¼ï¼Œä»¥åŠå…¶åŒ…å«çš„å¯¹åº”è­¦æŠ¥æŒ‡æ ‡æ•°æ®ï¼Œå¯ä»¥è‡ªå®šä¹‰Emailã€ä¼ä¸šå¾®ä¿¡çš„æ¨¡æ¿ï¼Œé…ç½®æŒ‡å®šçš„å­˜æ”¾ä½ç½®ï¼Œå¯¹äºé’‰é’‰çš„æ¨¡æ¿ä¼šå•ç‹¬è®²å¦‚ä½•é…ç½®ï¼Œè¿™é‡Œçš„æ¨¡æ¿æ˜¯æŒ‡çš„å‘é€çš„é€šçŸ¥æºä¿¡æ¯æ ¼å¼æ¨¡æ¿ï¼Œæ¯”å¦‚Emailï¼Œä¼ä¸šå¾®ä¿¡ã€‚

route

è­¦æŠ¥è·¯ç”±æ¨¡å—æè¿°äº†åœ¨æ”¶åˆ° Prometheus ç”Ÿæˆçš„è­¦æŠ¥åï¼Œå°†è­¦æŠ¥ä¿¡æ¯å‘é€ç»™æ¥æ”¶å™¨ receiver æŒ‡å®šçš„ç›®æ ‡åœ°å€è§„åˆ™ã€‚ Alertmanager å¯¹ä¼ å…¥çš„è­¦æŠ¥ä¿¡æ¯è¿›è¡Œå¤„ç†ï¼Œæ ¹æ®æ‰€å®šä¹‰çš„è§„åˆ™ä¸é…ç½®è¿›è¡ŒåŒ¹é…ã€‚å¯¹äºè·¯ç”±å¯ä»¥ç†è§£ä¸ºæ ‘çŠ¶ç»“æ„ï¼Œ
 è®¾ç½®çš„ç¬¬ä¸€ä¸ªrouteæ˜¯è·ŸèŠ‚ç‚¹ï¼Œå¾€ä¸‹çš„å°±æ˜¯åŒ…å«çš„å­èŠ‚ç‚¹ï¼Œæ¯ä¸ªè­¦æŠ¥ä¼ è¿›æ¥ä»¥åï¼Œä¼šä»é…ç½®çš„è·ŸèŠ‚ç‚¹è·¯ç”±è¿›å…¥è·¯ç”±æ ‘ï¼ŒæŒ‰ç…§æ·±åº¦ä¼˜å…ˆä»å·¦å‘å³éå†åŒ¹é…ï¼Œå½“åŒ¹é…çš„èŠ‚ç‚¹ååœæ­¢ï¼Œè¿›è¡Œè­¦æŠ¥å¤„ç†ã€‚

å‚æ•°æè¿°

| å‚æ•°                                       | æè¿°                                                         |                                                              |
| ------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| `receiver: <string>`                       | å‘é€è­¦æŠ¥çš„æ¥æ”¶å™¨åç§°                                         |                                                              |
| `group_by: ['label_name1,...']`            | æ ¹æ® prometheus çš„ lables è¿›è¡ŒæŠ¥è­¦åˆ†ç»„ï¼Œè¿™äº›è­¦æŠ¥ä¼šåˆå¹¶ä¸ºä¸€ä¸ªé€šçŸ¥å‘é€ç»™æ¥æ”¶å™¨ï¼Œä¹Ÿå°±æ˜¯è­¦æŠ¥åˆ†ç»„ã€‚ |                                                              |
| `match: [ <label_name>: <labelvalue>,...]` | é€šè¿‡æ­¤è®¾ç½®æ¥åˆ¤æ–­å½“å‰è­¦æŠ¥ä¸­æ˜¯å¦æœ‰æ ‡ç­¾çš„labelnameï¼Œç­‰åŒäºlabelvalueã€‚ |                                                              |
| `match_re: [<label_name>: <regex>,...]`    | é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼è¿›è¡Œè­¦æŠ¥é…ç½®                                   |                                                              |
| `group_wait: []                            | default=30s`                                                 | è®¾ç½®ä»æ¥å—è­¦æŠ¥åˆ°å‘é€çš„ç­‰å¾…æ—¶é—´ï¼Œè‹¥åœ¨ç­‰å¾…æ—¶é—´ä¸­groupæ¥æ”¶åˆ°æ–°çš„è­¦æŠ¥ä¿¡æ¯ï¼Œè¿™äº›è­¦æŠ¥ä¼šåˆå¹¶ä¸ºä¸€æ¡å‘é€ã€‚ |
| `group_interval: []                        | default=5m`                                                  | æ­¤è®¾ç½®æ§åˆ¶çš„æ˜¯ `group` ä¹‹é—´å‘é€è­¦æŠ¥é€šçŸ¥çš„é—´éš”æ—¶é—´ã€‚          |
| `repeat_interval: []                       | default=4h`                                                  | æ­¤è®¾ç½®æ§åˆ¶çš„æ˜¯è­¦æŠ¥å‘é€æˆåŠŸä»¥åï¼Œæ²¡æœ‰å¯¹è­¦æŠ¥åšè§£å†³æ“ä½œçš„è¯ï¼ŒçŠ¶æ€ `Firing` æ²¡æœ‰å˜æˆ `Inactive` æˆ–è€… `Pending` ï¼Œä¼šå†æ¬¡å‘é€è­¦æŠ¥çš„çš„é—´éš”æ—¶é—´ã€‚ |
| `routes: - <route>`...                     | å­è·¯ç”±çš„åŒ¹é…è®¾ç½®                                             |                                                              |

## route è·¯ç”±åŒ¹é…è§„åˆ™

```
route:
  receiver: admin # é»˜è®¤çš„æ¥æ”¶å™¨åç§°
  group_wait: 30s # åœ¨ç»„å†…ç­‰å¾…æ‰€é…ç½®çš„æ—¶é—´ï¼Œå¦‚æœåŒç»„å†…ï¼Œ30ç§’å†…å‡ºç°ç›¸åŒæŠ¥è­¦ï¼Œåœ¨ä¸€ä¸ªç»„å†…å‡ºç°ã€‚
  group_interval: 5m # å¦‚æœç»„å†…å†…å®¹ä¸å˜åŒ–ï¼Œ5måå‘é€ã€‚
  repeat_interval: 24h # å‘é€æŠ¥è­¦é—´éš”ï¼Œå¦‚æœæŒ‡å®šæ—¶é—´å†…æ²¡æœ‰ä¿®å¤ï¼Œåˆ™é‡æ–°å‘é€æŠ¥è­¦
  group_by: [alertname,cluster]  # æŠ¥è­¦åˆ†ç»„ï¼Œæ ¹æ® prometheus çš„ lables è¿›è¡ŒæŠ¥è­¦åˆ†ç»„ï¼Œè¿™äº›è­¦æŠ¥ä¼šåˆå¹¶ä¸ºä¸€ä¸ªé€šçŸ¥å‘é€ç»™æ¥æ”¶å™¨ï¼Œä¹Ÿå°±æ˜¯è­¦æŠ¥åˆ†ç»„ã€‚
  routes:
      - match:
          team: ops
        group_by: [env,dc]
        receiver: 'ops'
      - match_re:
          service: nginx|apache
        receiver: 'web'
      - match_re:
          service: mysql|mongodb
        receiver: 'db'
      - match_re:
          service: hbase|spark
        receiver: 'hadoop'
```

åœ¨ä»¥ä¸Šçš„ä¾‹å­ä¸­ï¼Œé»˜è®¤çš„è­¦æŠ¥ç»„å…¨éƒ¨å‘é€ç»™ admin ï¼Œä¸”æ ¹æ®è·¯ç”±æŒ‰ç…§ alertname cluster  è¿›è¡Œè­¦æŠ¥åˆ†ç»„ã€‚åœ¨å­è·¯ç”±ä¸­çš„è‹¥åŒ¹é…è­¦æŠ¥ä¸­çš„æ ‡ç­¾ team çš„å€¼ä¸º opsï¼ŒAlertmanager ä¼šæŒ‰ç…§æ ‡ç­¾ env dc  è¿›è¡Œè­¦æŠ¥åˆ†ç»„ç„¶åå‘é€ç»™æ¥æ”¶å™¨ receiver opsé…ç½®çš„è­¦æŠ¥é€šçŸ¥æºã€‚
 ç»§ç»­åŒ¹é…çš„æ“ä½œæ˜¯å¯¹ service æ ‡ç­¾è¿›è¡ŒåŒ¹é…ï¼Œå¹¶ä¸”é…åˆ°äº† nginx redis mongodb çš„å€¼ï¼Œå°±ä¼šå‘æ¥æ”¶å™¨ receiver webé…ç½®çš„è­¦æŠ¥é€šçŸ¥æºå‘é€è­¦æŠ¥ä¿¡æ¯ã€‚

å¯¹è¿™ç§åŒ¹é…éªŒè¯æ“ä½œç°å¸¸è€ƒç©¶ä¸ªäººçš„é€»è¾‘æ€ç»´èƒ½åŠ›ï¼Œè¿™ä¸æ˜¯äººå¹²çš„äº‹æƒ…å‘€~å› æ­¤ï¼ŒPrometheuså‘å¸ƒäº†ä¸€ä¸ª Routing tree editorï¼Œ
 ç”¨äºæ£€æµ‹Alertmanagerçš„é…ç½®æ–‡ä»¶ç»“æ„é…ç½®ä¿¡æ¯ï¼Œç„¶åè°ƒè¯•ã€‚ä½¿ç”¨æ–¹æ³•å¾ˆç®€å•ï¼Œå°±æ˜¯æŠŠ alertmanager.yml çš„é…ç½®ä¿¡å¿ƒå¤åˆ¶åˆ°è¿™ä¸ªç«™ç‚¹ï¼Œç„¶åç‚¹å‡» Draw Routing Tree æŒ‰é’®ç”Ÿæˆè·¯ç”±ç»“æ„æ ‘ï¼Œ
 ç„¶ååœ¨ Match Label Set å‰é¢è¾“å…¥ä»¥ { = ""} æ ¼å¼çš„è­¦æŠ¥æ ‡ç­¾ï¼Œç„¶åç‚¹å‡» Match Label Set æŒ‰é’®ä¼šæ˜¾ç¤ºå‘é€çŠ¶æ€å›¾ã€‚

## receiver æ¥æ”¶å™¨

æ¥å—å™¨æ˜¯ä¸€ä¸ªç»Ÿç§°ï¼Œæ¯ä¸ª receiver éƒ½æœ‰éœ€è¦è®¾ç½®ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„åç§°ï¼Œå¹¶ä¸”å¯¹åº”ä¸€ä¸ªæˆ–è€…å¤šä¸ªé€šçŸ¥æ–¹å¼ï¼ŒåŒ…æ‹¬emailã€å¾®ä¿¡ã€Slackã€é’‰é’‰ç­‰ã€‚

å®˜æ–¹ç°åœ¨æ»¡è¶³çš„é…ç½®æ˜¯ï¼š

```
name: <string>
email_config:
    [ - <config> ]
hipchat_configs: #æ­¤æ¨¡å—é…ç½®å·²ç»è¢«ç§»é™¤äº†
    [ <config> ]
pagerduty_configs:
    [ <config> ]
pushover_configs:
    [ <config> ]
slack_configs:
    [ <config> ]
opsgenie_configs:
    [ <config> ]
webhook_configs:
    [ <config> ]
victorops_configs:
    [ <config> ]
webchat_configs:
    [ <config> ]
```

å¯ä»¥çœ‹åˆ°Alertmanageræä¾›äº†å¾ˆå¤šç§æ¥æ”¶å™¨çš„é€šçŸ¥é…ç½®ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨webhookæ¥æ”¶å™¨æ¥å®šä¹‰é€šçŸ¥é›†æˆï¼Œæ”¯æŒç”¨æˆ·è‡ªå·±å®šä¹‰ç¼–å†™ã€‚

## inhibit_rules æŠ‘åˆ¶å™¨

inhibit_rules æ¨¡å—ä¸­è®¾ç½®è­¦æŠ¥æŠ‘åˆ¶åŠŸèƒ½ï¼Œå¯ä»¥æŒ‡å®šåœ¨ç‰¹å®šæ¡ä»¶ä¸‹éœ€è¦å¿½ç•¥çš„è­¦æŠ¥æ¡ä»¶ã€‚å¯ä»¥ä½¿ç”¨æ­¤é€‰é¡¹è®¾ç½®é¦–é€‰ï¼Œæ¯”å¦‚ä¼˜å…ˆå¤„ç†æŸäº›è­¦æŠ¥ï¼Œå¦‚æœåŒä¸€ç»„ä¸­çš„è­¦æŠ¥åŒæ—¶å‘ç”Ÿï¼Œåˆ™å¿½ç•¥å…¶ä»–è­¦æŠ¥ã€‚
 åˆç†ä½¿ç”¨ inhibit_rules ï¼Œå¯ä»¥å‡å°‘é¢‘å‘å‘é€æ²¡æœ‰æ„ä¹‰çš„è­¦æŠ¥çš„äº§ç”Ÿã€‚

inhibit_rules é…ç½®ä¿¡æ¯ï¼š

```
trget_match:
     [ <label_name>: <labelvalue>,... ]
trget_match_re:
     [ <label_name>: <labelvalue>,... ]
source_match:
     [ <label_name>: <labelvalue>,... ]
source_match_re:
     [ <label_name>: <labelvalue>,... ]
[ equal: '[' <lable_name>, ...]']
inhibit_rules: # æŠ‘åˆ¶è§„åˆ™
  - source_match: # æºæ ‡ç­¾è­¦æŠ¥è§¦å‘æ—¶æŠ‘åˆ¶å«æœ‰ç›®æ ‡æ ‡ç­¾çš„è­¦æŠ¥ï¼Œåœ¨å½“å‰è­¦æŠ¥åŒ¹é… status: 'High'
      status: 'High'  # æ­¤å¤„çš„æŠ‘åˆ¶åŒ¹é…ä¸€å®šåœ¨æœ€ä¸Šé¢çš„routeä¸­é…ç½®ä¸ç„¶ï¼Œä¼šæç¤ºæ‰¾ä¸keyã€‚
    target_match:
      status: 'Warning' # ç›®æ ‡æ ‡ç­¾å€¼æ­£åˆ™åŒ¹é…ï¼Œå¯ä»¥æ˜¯æ­£åˆ™è¡¨è¾¾å¼å¦‚: ".*MySQL.*"
    equal: ['alertname','operations', 'instance'] # ç¡®ä¿è¿™ä¸ªé…ç½®ä¸‹çš„æ ‡ç­¾å†…å®¹ç›¸åŒæ‰ä¼šæŠ‘åˆ¶ï¼Œä¹Ÿå°±æ˜¯è¯´è­¦æŠ¥ä¸­å¿…é¡»æœ‰è¿™ä¸‰ä¸ªæ ‡ç­¾å€¼æ‰ä¼šè¢«æŠ‘åˆ¶ã€‚
```

ä»¥ä¸Šç¤ºä¾‹æ˜¯æŒ‡ å¦‚æœåŒ¹é… equal ä¸­çš„æŠ‘åˆ¶çš„æ ‡ç­¾å€¼ï¼Œè§¦å‘äº†åŒ…å« equal ä¸­çš„æ ‡ç­¾å€¼çš„ status: 'High' è­¦æŠ¥ ï¼Œåˆ™ä¸å‘é€å«åŒ…å« equal ä¸­çš„æ ‡ç­¾å€¼çš„ status: 'Warning' æ ‡ç­¾çš„è­¦æŠ¥ã€‚
 è¿™é‡Œå°½é‡é¿å… source_match ä¸ target_match ä¹‹é—´çš„é‡å ï¼Œå¦åˆ™å¾ˆéš¾åšåˆ°ç†è§£ä¸ç»´æŠ¤ï¼ŒåŒæ—¶å»ºè®®è°¨æ…ä½¿ç”¨æ­¤åŠŸèƒ½ã€‚ä½¿ç”¨åŸºäºç—‡çŠ¶çš„è­¦æŠ¥æ—¶ï¼Œè­¦æŠ¥ä¹‹é—´å¾ˆå°‘éœ€è¦ç›¸äº’ä¾èµ–ã€‚

# è­¦æŠ¥é€šçŸ¥æ¥æ”¶å™¨

å‰é¢ä¸€ç›´æ˜¯åœ¨Web UI æŸ¥çœ‹è­¦æŠ¥ä¿¡æ¯ï¼Œç°åœ¨å¼€å§‹ä½¿ç”¨æ¥æ”¶å™¨ä¸Alertmanageré›†æˆï¼Œå‘é€è­¦æŠ¥ä¿¡æ¯åˆ°  Emailã€ä¼ä¸šå¾®ä¿¡ã€é’‰é’‰æœºå™¨äººï¼Œå¯¹äºè­¦æŠ¥è¦æ±‚æ¯”è¾ƒé«˜çš„åŒå­¦ï¼Œå¯ä»¥æ ¹æ®ä¸‹é¢æåˆ°çš„å¼€æºç»„ä»¶ ã€PrometheusAlertå…¨å®¶æ¡¶ã€‘  é…ç½®é£ä¹¦ã€çŸ­ä¿¡ã€è¯­éŸ³ç”µè¯ç­‰è­¦æŠ¥ã€‚

## Email

Alertmanageré»˜è®¤æ”¯æŒé…ç½®Emailï¼Œä¹Ÿæ˜¯æœ€æ™®é€šçš„æ–¹å¼ï¼Œåœ¨Alertmanagerç»„ä»¶ä¸­å†…ç½®äº†SMTPåè®®ã€‚ç›´æ¥å¯ä»¥æŠŠå‰é¢çš„Alertmanager.ymlä¸­çš„SMTPéƒ¨åˆ†æˆªå–å‡ºæ¥ï¼Œç„¶åè¿›è¡Œè°ƒæ•´ä¸é…ç½®

```
global:
  resolve_timeout: 5m
  # smtpé…ç½®
  smtp_from: "1234567890@qq.com" # å‘é€é‚®ä»¶ä¸»é¢˜
  smtp_smarthost: 'smtp.qq.com:465' # é‚®ç®±æœåŠ¡å™¨çš„SMTPä¸»æœºé…ç½®
  smtp_auth_username: "1234567890@qq.com" # ç™»å½•ç”¨æˆ·å
  smtp_auth_password: "auth_pass" # æ­¤å¤„çš„auth passwordæ˜¯é‚®ç®±çš„ç¬¬ä¸‰æ–¹ç™»å½•æˆæƒå¯†ç ï¼Œè€Œéç”¨æˆ·å¯†ç ï¼Œå°½é‡ç”¨QQæ¥æµ‹è¯•ã€‚
  smtp_require_tls: false # æœ‰äº›é‚®ç®±éœ€è¦å¼€å¯æ­¤é…ç½®ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯163é‚®ç®±ï¼Œä»…åšæµ‹è¯•ï¼Œä¸éœ€è¦å¼€å¯æ­¤åŠŸèƒ½ã€‚
route:
  receiver: ops
  group_wait: 30s # åœ¨ç»„å†…ç­‰å¾…æ‰€é…ç½®çš„æ—¶é—´ï¼Œå¦‚æœåŒç»„å†…ï¼Œ30ç§’å†…å‡ºç°ç›¸åŒæŠ¥è­¦ï¼Œåœ¨ä¸€ä¸ªç»„å†…å‡ºç°ã€‚
  group_interval: 5m # å¦‚æœç»„å†…å†…å®¹ä¸å˜åŒ–ï¼Œåˆå¹¶ä¸ºä¸€æ¡è­¦æŠ¥ä¿¡æ¯ï¼Œ5måå‘é€ã€‚
  repeat_interval: 24h # å‘é€æŠ¥è­¦é—´éš”ï¼Œå¦‚æœæŒ‡å®šæ—¶é—´å†…æ²¡æœ‰ä¿®å¤ï¼Œåˆ™é‡æ–°å‘é€æŠ¥è­¦ã€‚
  group_by: [alertname]  # æŠ¥è­¦åˆ†ç»„
  routes:
      - match:
          team: operations
        group_by: [env,dc]
        receiver: 'ops'
      - receiver: ops # è·¯ç”±å’Œæ ‡ç­¾ï¼Œæ ¹æ®matchæ¥æŒ‡å®šå‘é€ç›®æ ‡ï¼Œå¦‚æœ ruleçš„lable åŒ…å« alertnameï¼Œ ä½¿ç”¨ ops æ¥å‘é€
        group_wait: 10s
        match:
          team: operations
# æ¥æ”¶å™¨æŒ‡å®šå‘é€äººä»¥åŠå‘é€æ¸ é“
receivers:
# opsåˆ†ç»„çš„å®šä¹‰
- name: ops
  email_configs:
  - to: '9935226@qq.com,xxxxx@qq.com' # å¦‚æœæƒ³å‘é€å¤šä¸ªäººå°±ä»¥ ','åšåˆ†å‰²ï¼Œå†™å¤šä¸ªé‚®ä»¶äººå³å¯ã€‚
    send_resolved: true
    headers:
      from: "è­¦æŠ¥ä¸­å¿ƒ"
      subject: "[operations] æŠ¥è­¦é‚®ä»¶"
      to: "å°ç…œç‹¼çš‡"
```

é…ç½®å®Œæˆåï¼Œç›´æ¥é‡å¯Alertmanagerç»„ä»¶ï¼Œä½¿é…ç½®ç”Ÿæ•ˆï¼Œç„¶åä½¿ç”¨å‰é¢å†…å­˜é˜ˆå€¼è§¦å‘ä¸€æ¬¡è­¦æŠ¥æ¥çœ‹ä¸‹å‘é€ç»“æœã€‚

![img](https://img2020.cnblogs.com/blog/794174/202101/794174-20210107171522866-1493754932.png)
 ![img](https://img2020.cnblogs.com/blog/794174/202101/794174-20210107171531794-618258776.png)

## ä¼ä¸šå¾®ä¿¡

é¦–å…ˆä½ è¦å…·æœ‰ä¼ä¸šå¾®ä¿¡ç®¡ç†å‘˜çš„æƒé™ï¼Œå¦‚æœæ²¡æœ‰å¯ä»¥è‡ªå·±æ³¨å†Œä¸€ä¸ªï¼Œè¿›è¡Œæµ‹è¯•ï¼Œæˆ‘è¿™é‡Œæœ‰è‡ªè¡Œæ³¨å†Œçš„ä¼ä¸šå¾®ä¿¡

ç¬¬ä¸€æ­¥ç™»å½•è¿›å…¥ä»¥åï¼Œåœ¨åº”ç”¨ç®¡ç†ä¸­æ–°å»ºåº”ç”¨ã€‚
 ![img](https://img2020.cnblogs.com/blog/794174/202101/794174-20210107171638649-262230338.png)
 ç¬¬äºŒæ­¥ï¼Œåˆ›å»ºåº”ç”¨ï¼Œä¿¡æ¯å¡«å†™å¦‚ä¸‹ï¼Œä¸Šä¼ åº”ç”¨logoéšæ„ã€‚
 ![img](https://img2020.cnblogs.com/blog/794174/202101/794174-20210107171655008-1006812772.png)
 åˆ›å»ºæˆåŠŸä»¥åå¦‚ä¸‹å›¾ã€‚
 ![img](https://img2020.cnblogs.com/blog/794174/202101/794174-20210107171709151-506385038.png)

è¿™æ—¶å€™éœ€è¦æŠŠ AgentId å’Œ Secret è®°å½•ä¸‹æ¥ï¼Œå¯¹äºä½ çš„è¿™ç§Secretä¿¡æ¯ï¼Œæœ€å¥½ç®¡ç†å¥½ï¼Œæˆ‘çš„ç”¨è¿‡å°±ä¼šåˆ é™¤ï¼Œæ‰€ä»¥ä¸ç”¨æ‹…å¿ƒå®‰å…¨éšæ‚£ã€‚

ç¬¬ä¸‰æ­¥ï¼Œç°åœ¨æˆ‘ä»¬æ¥ç”¨æ–°å»ºçš„ä¼ä¸šå¾®ä¿¡åº”ç”¨åœ¨Alertmanageré…ç½®ï¼Œå¯ä»¥é…ç½®å…¨å±€ï¼Œä¹Ÿå¯ä»¥å¯¹å•ç‹¬éœ€è¦å‘é€çš„æ¥æ”¶å™¨ï¼Œå› ä¸ºè­¦æŠ¥éœ€è¦åˆ†çº§ï¼Œæ‰€ä»¥éœ€è¦å•ç‹¬å¤„ç†ï¼Œåœ¨è¿™é‡Œä½¿ç”¨çš„çš„å•ç‹¬çš„é…ç½®ï¼Œéœ€è¦çŸ¥é“ ä¼ä¸šID ï¼Œä»¥åŠ éƒ¨é—¨ID ã€‚
 ![img](https://img2020.cnblogs.com/blog/794174/202101/794174-20210107171748264-826372312.png)

éƒ¨é—¨ID é€šè¿‡é€šè®¯å½•è·å–
 ![img](https://img2020.cnblogs.com/blog/794174/202101/794174-20210107171802889-95009841.png)

è¿™æ—¶å€™æˆ‘ä»¬é‡å¯Alertmanagerï¼Œç„¶åä½¿ç”¨ä¹‹å‰çš„æ–¹å¼æ¥è§¦å‘æ¨¡æ‹Ÿè­¦æŠ¥ï¼Œçœ‹çœ‹å‘é€æ˜¯ä¸æ˜¯å·²ç»æ²¡æœ‰é—®é¢˜äº†ï¼Œè¿™æ—¶æˆ‘ä»¬çš„ä¼ä¸šå¾®ä¿¡ä¸­ã€Emailéƒ½å¯ä»¥æ”¶åˆ°è­¦æŠ¥äº†ï¼Œè¿™é‡Œçš„è­¦æŠ¥å·²ç»è¢«æˆ‘ç”¨æ¨¡å—å¤„ç†è¿‡äº†ã€‚å¯è¯»æ€§ä¼šæ›´é«˜ã€‚

```
cat wechat.tmpl
## wechatæ¨¡æ¿
{{ define "wechat.default.message" }}
{{ if gt (len .Alerts.Firing) 0 -}}
Alerts Firing:
{{ range .Alerts }}
è­¦æŠ¥çº§åˆ«ï¼š{{ .Labels.status }}

è­¦æŠ¥ç±»å‹ï¼š{{ .Labels.alertname }}

æ•…éšœä¸»æœº: {{ .Labels.instance }}

è­¦æŠ¥ä¸»é¢˜: {{ .Annotations.summary }}

è­¦æŠ¥è¯¦æƒ…: {{ .Annotations.description }}

â± : {{ (.StartsAt.Add 28800e9).Format "2006-01-02 15:04:05" }}
{{- end }}
{{- end }}

{{ if gt (len .Alerts.Resolved) 0 -}}
Alerts Resolved:
{{ range .Alerts }}
è­¦æŠ¥çº§åˆ«ï¼š{{ .Labels.status }}

è­¦æŠ¥ç±»å‹ï¼š{{ .Labels.alertname }}

æ•…éšœä¸»æœº: {{ .Labels.instance }}

è­¦æŠ¥ä¸»é¢˜: {{ .Annotations.summary }}

è­¦æŠ¥è¯¦æƒ…: {{ .Annotations.description }}

â± : {{ (.StartsAt.Add 28800e9).Format "2006-01-02 15:04:05" }}
â² : {{ (.EndsAt.Add 28800e9).Format "2006-01-02 15:04:05" }}
{{- end }}
{{- end }}
{{- end }}
```

Firingè­¦æŠ¥ï¼š
 ![img](https://img2020.cnblogs.com/blog/794174/202101/794174-20210107171915220-1293388821.png)
 ä¸‹é¢æ˜¯Resolveçš„è­¦æŠ¥ï¼š
 ![img](https://img2020.cnblogs.com/blog/794174/202101/794174-20210107171938094-1498204281.png)

## é’‰é’‰æœºå™¨äºº(Webhook)

é¦–å…ˆéœ€è¦åœ¨é’‰é’‰åˆ›å»ºæœºå™¨äººï¼Œç„¶ååœ¨ç™½åå•ä¸­æ·»åŠ å…³é”®å­—ä¿¡æ¯ä¸ipé™åˆ¶ç­‰å®‰å…¨è®¾ç½®ï¼Œè¿™ä¸ªåªè¦ä½ æœ‰ç¾¤ï¼Œä½ å°±å¯ä»¥åœ¨ç¾¤é‡Œé¢å»ºï¼Œéå¸¸ç®€å•ï¼Œè¿™é‡Œå°±ä¸åšæ¼”ç¤ºäº†

å…ˆæŠŠPrometheus-webhook-Dingtalkç»„ä»¶è£…å¥½ã€‚

```
mkdir -p /etc/prometheus-webhook-dingtalk/template/
cd /etc/prometheus-webhook-dingtalk/
wget https://github.com/timonwong/prometheus-webhook-dingtalk/releases/download/v1.4.0/prometheus-webhook-dingtalk-1.4.0.linux-amd64.tar.gz
tar xf prometheus-webhook-dingtalk-1.4.0.linux-amd64.tar.gz
mv prometheus-webhook-dingtalk-1.4.0.linux-amd64/* /etc/prometheus-webhook-dingtalk/
mv prometheus-webhook-dingtalk /bin/
cat <<EOF> /lib/systemd/system/prometheus-webhook-dingtalk.service 
[Unit]
Description=prometheus-webhook-dingding
Documentation=https://prometheus.io/
After=network.target

[Service]
Type=simple
User=prometheus
ExecStart=/bin/prometheus-webhook-dingtalk --web.listen-address=":8070" --web.enable-ui --config.file="/etc/prometheus-webhook-dingtalk/config.yml"
Restart=on-failure

[Install]
WantedBy=multi-user.target
EOF
## å¯åŠ¨æœåŠ¡
systemctl enable prometheus-webhook-dingtalk.service
systemctl start prometheus-webhook-dingtalk.service
```

é…ç½®æ–‡ä»¶

```
## Request timeout
# timeout: 5s

## Customizable templates path
## Customizable templates path
templates:
        # - contrib/templates/legacy/template.tmpl
  # è‡ªå®šä¹‰æ¨¡æ¿è·¯å¾„
  - /etc/prometheus-webhook-dingtalk/template/default.tmpl

## ä½ è¿˜å¯ä»¥ä½¿ç”¨' default_message 'è¦†ç›–é»˜è®¤æ¨¡æ¿
## ä¸‹é¢çš„ç¤ºä¾‹ä½¿ç”¨v0.3.0ä¸­çš„â€œlegacyâ€æ¨¡æ¿
# default_message:
#   title: '{{ template "legacy.title" . }}'
#   text: '{{ template "legacy.content" . }}'

## Targets, previously was known as "profiles"
# å®šä¹‰çš„webhookï¼Œé’‰é’‰åˆ›å»ºçš„webhook token
targets:
# å¦‚æœæœ‰å¤šä¸ªåˆ†ç»„å°±å¯ä»¥åœ¨è¿™é‡Œå®šä¹‰å¤šä¸ªæ¥å£
  ops:
    url: https://oapi.dingtalk.com/robot/send?access_token=a4feed2322222222222222222222222
  web:
    url: https://oapi.dingtalk.com/robot/send?access_token=a4feed2325c1333333333333333333333
```

å®šä¹‰æ¨¡æ¿ï¼š

```
cd /etc/prometheus-webhook-dingtalk/template
cat default.tmpl
{{ define "__subject" }}[{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ .GroupLabels.SortedPairs.Values | join " " }} {{ if gt (len .CommonLabels) (len .GroupLabels) }}({{ with .CommonLabels.Remove .GroupLabels.Names }}{{ .Values | join " " }}{{ end }}){{ end }}{{ end }}
{{ define "__alertmanagerURL" }}{{ .ExternalURL }}/#/alerts?receiver={{ .Receiver }}{{ end }}

{{ define "__text_alert_list" }}{{ range . }}
**Labels**
{{ range .Labels.SortedPairs }}> - {{ .Name }}: {{ .Value | markdown | html }}
{{ end }}
**Annotations**
{{ range .Annotations.SortedPairs }}> - {{ .Name }}: {{ .Value | markdown | html }}
{{ end }}
**Source:** [{{ .GeneratorURL }}]({{ .GeneratorURL }})
{{ end }}{{ end }}

{{/* Firing */}}

{{ define "default.__text_alert_list" }}{{ range . }}

**Trigger Time:** {{ dateInZone "2006.01.02 15:04:05" (.StartsAt) "Asia/Shanghai" }}

**Summary:** {{ .Annotations.summary }}

**Description:** {{ .Annotations.description }}

**Graph:** [ğŸ“ˆ ]({{ .GeneratorURL }})

**Details:**
{{ range .Labels.SortedPairs }}{{ if and (ne (.Name) "severity") (ne (.Name) "summary") }}> - {{ .Name }}: {{ .Value | markdown | html }}
{{ end }}{{ end }}
{{ end }}{{ end }}

{{/* Resolved */}}

{{ define "default.__text_resolved_list" }}{{ range . }}

**Trigger Time:** {{ dateInZone "2006.01.02 15:04:05" (.StartsAt) "Asia/Shanghai" }}

**Resolved Time:** {{ dateInZone "2006.01.02 15:04:05" (.EndsAt) "Asia/Shanghai" }}

**Summary:** {{ .Annotations.summary }}

**Graph:** [ğŸ“ˆ ]({{ .GeneratorURL }})

**Details:**
{{ range .Labels.SortedPairs }}{{ if and (ne (.Name) "severity") (ne (.Name) "summary") }}> - {{ .Name }}: {{ .Value | markdown | html }}
{{ end }}{{ end }}
{{ end }}{{ end }}

{{/* Default */}}
{{ define "default.title" }}{{ template "__subject" . }}{{ end }}
{{ define "default.content" }}#### \[{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}\] **[{{ index .GroupLabels "alertname" }}]({{ template "__alertmanagerURL" . }})**
{{ if gt (len .Alerts.Firing) 0 -}}

![Firing-img](https://is3-ssl.mzstatic.com/image/thumb/Purple20/v4/e0/23/cf/e023cf56-0623-0cdf-afce-97ae90eabfda/mzl.uplmrpgi.png/320x0w.jpg)

**Alerts Firing**
{{ template "default.__text_alert_list" .Alerts.Firing }}
{{- end }}
{{ if gt (len .Alerts.Resolved) 0 -}}

![Resolved-img](https://is3-ssl.mzstatic.com/image/thumb/Purple18/v4/41/72/99/4172990a-f666-badf-9726-6204a320c16e/mzl.dypdixoy.png/320x0w.png)

**Alerts Resolved**
{{ template "default.__text_resolved_list" .Alerts.Resolved }}
{{- end }}
{{- end }}

{{/* Legacy */}}
{{ define "legacy.title" }}{{ template "__subject" . }}{{ end }}
{{ define "legacy.content" }}#### \[{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}\] **[{{ index .GroupLabels "alertname" }}]({{ template "__alertmanagerURL" . }})**
{{ template "__text_alert_list" .Alerts.Firing }}
{{- end }}

{{/* Following names for compatibility */}}
{{ define "ding.link.title" }}{{ template "default.title" . }}{{ end }}
{{ define "ding.link.content" }}{{ template "default.content" . }}{{ end }}
```

åœ¨Alertmanagerä¸­é…ç½®è­¦æŠ¥

```
# æ¥æ”¶å™¨æŒ‡å®šå‘é€äººä»¥åŠå‘é€æ¸ é“
receivers:
# opsåˆ†ç»„çš„å®šä¹‰
- name: ops
  email_configs:
  - to: '9935226@qq.com,10000@qq.com'
    send_resolved: true
    headers: { Subject: "[operations] æŠ¥è­¦é‚®ä»¶"} # æ¥æ”¶é‚®ä»¶çš„æ ‡é¢˜
  # é’‰é’‰é…ç½®
  webhook_configs:
  - url: http://localhost:8070/dingtalk/ops/send # è¿™é‡Œæ˜¯åœ¨é’‰é’‰å¼€æºç»„ä»¶ä¸­çš„æ¥å£ï¼Œå¦‚æœå•ç‹¬å®šä¹‰çš„receiveréœ€è¦å¯¹åº”ä½ çš„åˆ†ç»„ä¸é’‰é’‰æœºå™¨äººçš„webhook token
    # ä¼ä¸šå¾®ä¿¡é…ç½®
  wechat_configs:
  - corp_id: 'ww5421dksajhdasjkhj'
    api_url: 'https://qyapi.weixin.qq.com/cgi-bin/'
    send_resolved: true
    to_party: '2'
    agent_id: '1000002'
    api_secret: 'Tm1kkEE3RGqVhv5hO-khdakjsdkjsahjkdksahjkdsahkj'
# web
- name: web
  email_configs:
  - to: '9935226@qq.com'
    send_resolved: true
    headers: { Subject: "[web] æŠ¥è­¦é‚®ä»¶"} # æ¥æ”¶é‚®ä»¶çš„æ ‡é¢˜
  webhook_configs:
  - url: http://localhost:8070/dingtalk/web/send
```

ç»§ç»­ä½¿ç”¨ä¸Šé¢çš„è§¦å‘æ¨¡æ‹Ÿè­¦æŠ¥ï¼Œæ­¤æ—¶ä¼šåŒæ—¶è®©ä¸‰ä¸ªè­¦æŠ¥éƒ½æ¥å—åˆ°è­¦æŠ¥ä¿¡æ¯ï¼Œæˆ‘ä»¬è¿™é‡Œåªæ˜¯ä¸ºäº†è°ƒè¯•ï¼Œå¾€å¾€ä¸€ä¸ªè­¦æŠ¥é€šçŸ¥å°±å¯ä»¥æ»¡è¶³éœ€æ±‚äº†ï¼Œå¯¹äºé‡è¦ä¸šåŠ¡è¿˜æ˜¯éœ€è¦ä½¿ç”¨ç”µè¯ä»¥åŠçŸ­ä¿¡æé†’ã€‚

é’‰é’‰Firingè­¦æŠ¥ï¼š
 ![img](https://img2020.cnblogs.com/blog/794174/202101/794174-20210107172230405-1184850391.png)
 é’‰é’‰Resolveè­¦æŠ¥ï¼š
 ![img](https://img2020.cnblogs.com/blog/794174/202101/794174-20210107172248991-1914958086.png)

## è­¦æŠ¥é€šçŸ¥æ¨¡æ¿

Prometheus åˆ›å»ºè­¦æŠ¥è½¬å‘ç»™ Alertmanagerï¼ŒAlertmanagerä¼šæ ¹æ®ä¸åŒçš„ Label å‘ä¸åŒçš„  Receiver å‘é€è­¦æŠ¥é€šçŸ¥ï¼Œå¦‚Emailã€é’‰é’‰ã€ä¼ä¸šå¾®ä¿¡ã€é£ä¹¦ã€çŸ­ä¿¡ç­‰ç­‰ã€‚æ‰€æœ‰  Receiveréƒ½ä¸€ä¸ªæ¥æ”¶æ¨¡æ¿ï¼Œç„¶åé€šè¿‡æ¨¡æ¿æ ¼å¼åŒ–ä»¥åå‘é€è­¦æŠ¥ä¿¡æ¯ç»™ Receiverã€‚
 Alertmanager è‡ªå¸¦çš„æ¨¡æ¿æ˜¯åŸºäº Go è¯­è¨€çš„ template æ¨¡æ¿ï¼Œç”¨æˆ·å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚å»å®šä¹‰è‡ªå·±éœ€è¦çš„æ¨¡æ¿ï¼Œä¸Šé¢æˆ‘ç»™å‡ºçš„æ¨¡æ¿å·²ç»è¶³å¤Ÿå¤§å®¶çš„åŸºç¡€ä½¿ç”¨äº†ã€‚

ä¸‹é¢ä»‹ç»ä¸‹é€šå¸¸è‡ªå®šä¹‰æ¨¡æ¿ä¸­ä¼šéœ€è¦ç”¨åˆ°çš„ä¸€äº›å‚æ•°è¯´æ˜

| åç§°                 | æ•°æ®ç±»å‹ | æè¿°                                          |
| -------------------- | -------- | --------------------------------------------- |
| `Receiver`           | string   | æ¥å—è­¦æŠ¥é€šçŸ¥çš„æ¥æ”¶å™¨åç§°                      |
| `Status`             | string   | è­¦æŠ¥çŠ¶æ€ï¼Œä¾‹å¦‚ï¼šFiringæˆ–Resolvedçš„é€šçŸ¥        |
| `Alert`              | Alert    | è­¦æŠ¥é€šçŸ¥çš„çœŸå®å†…å®¹ï¼Œè­¦æŠ¥ä¸­çš„æ‰€æœ‰åˆ—è¡¨          |
| `GroupLables`        | KV       | åŒ…å«è­¦æŠ¥é€šçŸ¥çš„ç»„æ ‡ç­¾                          |
| `CommandLabels`      | KV       | æ‰€æœ‰è­¦æŠ¥çš„å…¬å…±æ ‡ç­¾ï¼ŒåŒ…å«GroupLabelsçš„æ‰€æœ‰æ ‡ç­¾ |
| `CommandAnnotations` | KV       | æ³¨é‡Šï¼Œæ¯”å¦‚è‡ªå®šä¹‰çš„ä¸€äº›å­—ç¬¦ä¸²                  |
| `ExternalURL`        | string   | è­¦æŠ¥ä¿¡æ¯ä¸­çš„Alertmanageråœ°å€                  |

ä¸Šé¢è¯´çš„KVç±»å‹æ˜¯ä¸€ç»„ä½¿ç”¨ä¸æ ‡ç¤ºæ ‡ç­¾ä¸æ³¨é‡Šçš„Key/Valueå­—ç¬¦ä¸²å¯¹ï¼Œå¯ä»¥åœ¨Alertmanagerä¸­çš„é»˜è®¤æ¨¡æ¿ä¸­çœ‹åˆ°å…¶å®šä¹‰ã€‚ default.tmpl

å…¶ä¸­é‚®ä»¶ä¸­æ‰€æ˜¾ç¤ºçš„ View In AlertManager ï¼ŒReceiver ä¸ ExternalURLçš„å®šä¹‰å…¶å®å°±æ˜¯æ¨¡æ¿ä¸­çš„ .ExternalURL ä¸ .Receiver ã€‚

```
{{ define "__alertmanager" }}AlertManager{{ end }}

{{ define "__alertmanagerURL" }}{{ .ExternalURL }}/#/alerts?receiver={{ .Receiver | urlquery }}{{ end }}
```

åœ¨æ”¶åˆ°çš„é‚®ç®±è­¦æŠ¥ä¸­å¯ä»¥çœ‹åˆ° View In AlertManager çš„é“¾æ¥åœ°å€æ˜¯ï¼šhttp://192.168.1.220:19093/#/alerts?receiver=ops ã€‚

å¯¹äºAlertçš„ç±»å‹ï¼Œè­¦æŠ¥åˆ—è¡¨çš„å­—æ®µè¿˜åŒ…å«äº†å¦‚ä¸‹å‚æ•°ä¸å®šä¹‰ã€æè¿°

| åç§°           | æ•°æ®ç±»å‹  | æè¿°                                                 |
| -------------- | --------- | ---------------------------------------------------- |
| `Status`       | string    | å®šä¹‰è­¦æŠ¥çŠ¶æ€æ˜¯å·²ç»è§£å†³æˆ–å¤„äºè§¦å‘çŠ¶æ€                 |
| `Label`        | KV        | åŒ…å«è­¦æŠ¥ä¸­çš„æ ‡ç­¾                                     |
| `Annotations`  | KV        | è­¦æŠ¥çš„ä¸€ç»„æ³¨é‡Š                                       |
| `StartsAt`     | time.Time | è­¦æŠ¥è§¦å‘æ—¶é—´                                         |
| `EndsAt`       | time.Time | è­¦æŠ¥ç»“æŸæ—¶é—´ï¼Œåªåœ¨è­¦æŠ¥ç»“æŸçš„æ—¶é—´æ—¶è®¾ç½®               |
| `GeneratorURL` | string    | è­¦æŠ¥è§„åˆ™çš„è¿æ¥URLï¼Œä¹Ÿå°±æ˜¯Prometheusä¸­çš„RulesæŸ¥è¯¢åœ°å€ |

å¯¹äºè­¦æŠ¥ä¸­çš„é€šçŸ¥æ¨¡æ¿é¦–å…ˆè¦ç†Ÿæ‚‰goè¯­è¨€çš„templateè¯­æ³•ä»¥åŠHTMLç®€å•çš„åŸºç¡€çŸ¥è¯†ï¼Œç„¶åæŠŠä¸Šé¢ç›¸å…³çš„å…ƒæ•°æ®çš„ä¸€äº›ä¿¡æ¯äº†è§£æ¸…æ¥šï¼Œå°±å¯ä»¥è‡ªå·±è°ƒæ•´æ¨¡æ¿äº†ï¼Œå¦‚æœä½ å®åœ¨æ‡’çš„æ”¹ï¼Œæˆ‘è°ƒæ•´å¥½çš„æ¨¡æ¿å¯ä»¥ç›´æ¥æ‹¿å»ç”¨ï¼ŒæŠŠå¯¹åº”çš„æŒ‡æ ‡ã€æ ‡ç­¾åå­—æ”¹ä¸€ä¸‹å°±å¯ä»¥ç”¨äº†ã€‚

ä»¥ä¸‹æ˜¯æˆ‘è‡ªå·±ä¿®æ”¹äº†ä¸€ä¸‹çš„æ¨¡æ¿è­¦æŠ¥æ ¼å¼ï¼Œå¤§å®¶å¯ä»¥çœ‹çœ‹ï¼Œè¿™ä¸ªæ˜¯é€šè¿‡å®˜æ–¹çš„ default.tmpl ä¿®æ”¹çš„ã€‚

![img](https://img2020.cnblogs.com/blog/794174/202101/794174-20210107172506619-173537672.png)

## å¼€æºè­¦æŠ¥ç»„ä»¶æ¨è

- Prometheus-Webhook-Dingtalk

ä¸€ä¸ªå¼€æºçš„ç¬¬ä¸‰æ–¹è­¦æŠ¥æ’ä»¶ï¼Œé’ˆå¯¹é’‰é’‰æœºå™¨äºº webhook åšé›†æˆï¼ŒGoè¯­è¨€ç¼–å†™ï¼Œç°åœ¨è¿­ä»£çš„å·²ç»å¾ˆä¸é”™äº†ï¼Œå¯èƒ½æœ‰ä¸€äº›åŠŸèƒ½è¿˜æ˜¯æœ‰äº›é™åˆ¶ï¼Œæ¯”å¦‚é’ˆå¯¹ Markdown @æŸä¸ªäººæ— æ³•å®ç°ï¼ŒåŸå› æ˜¯å› é’‰é’‰è‡ªèº«APIæ²¡æœ‰æ”¯æŒè¿™ä¸ªåŠŸèƒ½ã€‚

- Alertmanager-wechatrobot-webhook

è¿™ä¸ªå¼€æºç»„ä»¶æ˜¯å°†Alertmanger Webhook æ¶ˆæ¯è½¬æ¢ä¸ºå¯ä»¥æ¥æ”¶æ¶ˆæ¯çš„ä¼ä¸šå¾®ä¿¡æœºå™¨äººï¼Œä¹Ÿæ˜¯goè¯­è¨€ç¼–å†™ï¼ŒAlertmanager é»˜è®¤å·²ç»é›†æˆä¼ä¸šå¾®ä¿¡é…ç½®ï¼Œå¦‚æœæœ‰ç‰¹æ®Šéœ€æ±‚ï¼Œéœ€è¦ä½¿ç”¨ä¼ä¸šå¾®ä¿¡æœºå™¨äººçš„å¯ä»¥çœ‹çœ‹è¿™ä¸ªã€‚

- PrometheusAlertå…¨å®¶æ¡¶

å¦‚æœæœ‰å¯¹çŸ­ä¿¡ã€ç”µè¯è­¦æŠ¥ç­‰å…¶ä»–éœ€æ±‚çš„åŒå­¦ï¼Œæ¨èè¿™ä¸ªå¼€æºè­¦æŠ¥ç»„ä»¶ï¼ŒGoè¯­è¨€ç¼–å†™ï¼ŒWebæ¡†æ¶æ˜¯ Beego ï¼Œæ”¯æŒå°†æ”¶åˆ°çš„è¿™äº›æ¶ˆæ¯å‘é€åˆ°é’‰é’‰ï¼Œå¾®ä¿¡ï¼Œé£ä¹¦ï¼Œè…¾è®¯çŸ­ä¿¡ï¼Œè…¾è®¯ç”µè¯ï¼Œé˜¿é‡Œäº‘çŸ­ä¿¡ï¼Œé˜¿é‡Œäº‘ç”µè¯ï¼Œåä¸ºçŸ­ä¿¡ï¼Œå®¹è”äº‘ç”µè¯ç­‰