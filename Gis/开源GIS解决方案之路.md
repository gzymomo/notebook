- [开源GIS解决方案之路](https://www.cnblogs.com/gisarmory/p/14600952.html)



## 第五版 2021年

### 背景

这一版还没有完成，年前刚做完技术预研工作，这里先把整体的思路简单和大家分享一下。

总的来说，上一版已经很好用了，现在已经很少有来自用户的负面反馈。产品还曾在大项目中作为技术中台，提供给其他公司使用，同样效果很好。

但我们自己还是有追求的，和高德、百度地图API相比，我们在下面几点上还需要改进：

1. 地图美观度问题。
    地图的底图目前都是使用互联网地图瓦片，叠加上业务数据后，会遮盖底图中的注记，业务数据间的注记也不容易实现自动避让，再加上没有好用的地图配图工具，导致地图在展示多样数据时就会显得很乱、很丑。
2. 展示性能问题。
    地图有时需要一些动画效果，比如用动画效果表达管网中水的流动方向和快慢，在数据量较大时会出现明显的卡顿。
3. 地图配图问题。
    geoserver配图不好用，这个问题前面已经提到过，虽然使用SLDEditor可以生成配色文件，但一次只能生成一个图层，没有办法整体预览，效率太低，体验太差。高德、百度地图的自定义地图配图工具就很好用，美工可以直接上手，眼馋很久了。

这一版的目标是解决上面3个问题，并继续优化用户体验。

### 技术选型

前台改为使用mapboxgl，不再使用leaflet，原因有两个：

1. 性能。leaflet的上限在10万左右（详见：[leaflet如何加载10万数据](http://gisarmory.xyz/blog/index.html?blog=leaflet100ThousandData)），而mapboxgl基于webgl技术开发，最大数据量取决于显卡性能和网络传输速度，理想情况下可以轻松达到百万级别。
2. 美观度。mapboxgl对矢量瓦片支持特别好，再结合maputnik可以轻松实现高德、百度地图的自定义地图功能。

地图配图使用maputnik，业务数据使用geoserver发布矢量瓦片，正常maputnik是不支持geoserver发布的矢量瓦片的，不过我们已经把这个问题解决了，详见：[如何让矢量瓦片配图神器maputnik支持 geoserver](http://gisarmory.xyz/blog/index.html?blog=maputnikGeoserverVectorTiles)

底图数据有两种方案：

1. 继续使用互联网地图栅格瓦片，适合对底图数据准确性要求较高的情况。
2. 在本地发布OSM矢量瓦片地图，目前网上没有可以直接使用的免费矢量瓦片资源，只能自己把OSM数据下载到本地自己发布。OSM地图在国内的数据质量比较差，如果你的业务对底图数据的准确性要求不高，对样式要求比较高，比如大屏展示系统，可以选用这个方案。具体方法详见： [如何实现OSM地图本地发布并自定义配图](https://blog.csdn.net/gisarmory/article/details/110931322)

地图可视化效果使用deck.gl、L7来实现。

### 经验总结

1. 使用maputnik同时加载geoserver发布的业务图层和本地发布的OSM底图，可以实现业务数据和底图的深度融合，比如把业务数据中的河流放到底图道路图层的下方，并实现标签的自动避让功能，类似这样的体验还是非常爽的。
2. OSM地图的合规性存疑，建议自行将中国的国界线校准一遍再用。

## 后续展望

1. 解决OSM地图数据量少的问题。

   第五版解决方案有一点不完美的地方是，OSM地图在国内的数据量较少，这也是在我年初的Flag中，想要通过机器学习自动提取建筑物轮廓的起因。

2. 研究三维GIS。

   之前的工作一直是二维GIS，三维GIS的业务比较少，也研究了cesium、ArcGIS js API 4.x、three.js  等，并在项目上有过使用，但对三维GIS的整体理解还是不像二维GIS那样通透，不能像二维GIS那样信心十足的给出一个自己满意的开源解决方案，所以在这块儿需要继续努力。

## 总结

### 关于地图API

在toG业务的公司中，想要通过开源GIS，打造一套在易用性上比肩高德、百度地图的API，需要注意以下几点：

1. 解决地图资源问题。把网上的地图资源整理好，把项目上的业务地图资源整理好，对外让用户可以直接使用。
2. 解决地图坐标系问题。要搞定互联网地图的偏移问题，和多种地图坐标间的转换问题，对外让用户只使用一种坐标。
3. 基础地图功能通过用户教育的方式实现，也就是提供完善的调用示例和说明文档。高级地图功能通过封装插件的方式实现，这样可以避免随着时间的推延，核心API越来越冗余。
4. 场景丰富的、可以直接使用的调用示例，比接口是否简介、文档是否详细更重要。
5. 用户觉得地图API是否好用的影像因素，从高到低排序：能不能解决问题、有没有bug、有没有丰富的示例、技术支持是否到位、文档是否清晰。
6. 己所不欲勿施于人。找一个真实的业务场景去使用自己的API，并不断的从中发现问题，解决问题，完善功能，直到自己觉得非常好用为止，这样可以强迫自己站在用户的角度去思考问题。如果自己都不愿意去用，那就肯定是不好用，最终不会走的长远。
7. 要做好技术支持工作。开发地图API需要一个长期的、持续迭代的过程，这个过程中难免有这样那样的问题，如果你的用户支持好，它能帮你弥补那些问题给用户带来的不好体验。
8. 学会通过工具提高平台维护效率。多去想想平台维护的过程中，哪些环节可以通过自动化或半自动的方式完成，比如生成文档环节、更新部署环节等，节省了时间好去研究更深层次的东西。

### 关于开源GIS解决方案

下面是我推荐的两种组合方案，其实都是前面提到过的，这里汇总一下。

轻量版：leaflet + geoserver + postGIS

这个组合网上的资料多，软件简单易用，普适性强，能满足绝大多数人对二维GIS的需求。

矢量瓦片版：mapboxgl + maputnik + geoserver + postGIS + openmaptiles + three.js

这个组合可以搭建出一套类似高德、百度地图的自定义地图，也可以实现白模三维地图，如果你比较看重地图可视化效果，那么推荐你使用这一套。